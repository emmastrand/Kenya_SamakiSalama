---
title: "Quality Control of Fishing Landings dataset"
author: "Emma Strand; emma_strand@uri.edu"
output:
  github_document: default
  pdf_document:
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Questions for Austin 

1. Is there a set list of options for categories like enumerator, landing_site, BMU, and trap_type that I can compare the dataset against? e.g. are “KIJANGWANI” and “KITANGANI” the same landing site or 2 different ones? A validation list for the fishing operation sheet? I have the validation list for the catch composition.  
2. Are phone numbers a certain # of digits?  
3. Time in water (effort) doesn’t have any data so I removed it for now. Is this supposed to?  
4. What are the expected ranges for total traps collected, weight and value measures, no of fishers in crew, and number of fish caught?    
5. In the Catching information section under the Species / Scientific name section, take a look at #1 and #2 and the suggestion fixes on those. What do you think?  

## Contents 

- [**Protocol to run this with a future xlsx file**](#protocol)   
- [**Load all libraries**](#libraries)  
- [**Create dataframe**](#df)  
- [**Quality Control: enumerator**](#Enumerator)  
- [**Quality Control: landing_site and BMU**](#Landing_site)  
- [**Quality Control: fisher information**](#fisher_info)  
- [**Quality Control: trap information**](#trap)  
- [**Quality Control: catch information**](#catch)  
- [**Gear type, and fish numbers/final destination**](#gear)  
- [**Quality Control: final check for notes written by field team**](#notes)   
- [**Exporting cleaned dataset**](#export)  

## <a name="protocol"></a> **Protocol to run this with a future xlsx file**

1. In the toolbar above, hit the arrow next to `Knit`. Scroll down to `Knit Directory` and select the option `Project Directory`.    
2. **In `Create dataframe` code chunk**: Replace raw data file name in the function that creates the following variables: fishing_operation, catch_composition, and validation_lists.    
3. **In `Enumerator`, `Landing_site`, and `BMU` code chunks**: Run the unique() function and double check that this list is the correct names.  
4. **In Trap information**, run code chunk functions for `trap_type` and `total_traps_collected` sections and double check the output is as expected.  
5. **In catch information**, run code chunk functions for `weight and value measures`, `number of fishers in crew`, and `Kiswahili_name` and double check the output is as expected.  
6. **In Species/Scientific name**, run code chunk functions and check output to make sure it is as expected.  
7. **In length, gear type, number of fish, and desintation sections**, run code chunk to double check the output of ranges is as expected.  
8. In the export section, rename the new datafile excel file.  


4. **In `total_traps_collected`, `Weight and value measures`, and `No. of fishers in crew` code chunks**: Run range() functions on new dfs to double check these ranges are expected.   
5. 

## <a name="libraries"></a> **Load all libraries**

```{r, message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(readxl)
library(lubridate)
library(Hmisc)
library(writexl)
```

## <a name="df"></a> **Create dataframe**

**Load in raw data files.** 

[Reading in an excel datafile instead of a csv](http://www.sthda.com/english/wiki/reading-data-from-excel-files-xls-xlsx-into-r). This requires the `readxl` package listed in load all libraries step. 

```{r, message=FALSE, warning=FALSE}
## when running future iterations of raw data file, replace the file name below 
fishing_operation <- read_excel("data/Fishlandings-data_21052022-May_update-cleaning in progress.xlsx", sheet = "fishing_operation") %>%
  select(-'...21', -'...22', -'...23') %>%
  rename(Operation_date = date_dd_mm_yyyy)

nrow(fishing_operation) #2407 fishing operations (keep this # in mind for sanity check at the end)

## when running future iterations of raw data file, replace the file name below 
catch_composition <- read_excel("data/Fishlandings-data_21052022-May_update-cleaning in progress.xlsx", sheet = "catch_composition") %>%
  select(-'...10', -'...11', -'...12', -'...13') %>%
  rename(Operation_date = Date)

nrow(catch_composition) #14761 fish observations (keep this # in mind for sanity check at the end)

## when running future iterations of raw data file, replace the file name below 
validation_lists <- read_excel("data/Fishlandings-data_21052022-May_update-cleaning in progress.xlsx", sheet = "validation_lists")
```

Errors found in fisher_id column are mostly capitalization errors. 

```{r}
fishing_operation$fisher_id <- toupper(fishing_operation$fisher_id)
catch_composition$fisher_id <- toupper(catch_composition$fisher_id)
```

Creating a larger dataframe to work with for the rest of quality control. 
```{r}
df <- full_join(fishing_operation, catch_composition, by = c("fisher_id", "Operation_date")) %>%
  select(-`time_in_water (effort)`) %>% # take this out if we start collecting time in water data
  rename(fishing_operation_notes= general_notes) %>%
  rename(catch_composition_notes = notes_picture) %>%
  rename(scientific_name = SPECIES)
```

## Quality Control 

### Operation_date 

In the above chunk, these dates are automatically read in as *dttm* format (date and time). 

### <a name="Enumerator"></a> **Enumerator**

[Replace character string with another in R](https://stackoverflow.com/questions/11936339/replace-specific-characters-within-strings)

A lot of errors occur with different lower and upper case iterations of names. I replaced this information with all upper case to collapse this information. For example, "kadzo baya" and "Kadzo baya" are the same fisherman but were reading as different categories. 

```{r}
# change all lower case to upper case
df$enumerator <- toupper(df$enumerator)

unique(df$enumerator) # prints all categories that show up in that column 
## at this point, assess errors in that list for spelling mistakes to replace below 
```

```{r}
# replace incorrect spellings 
df$enumerator <- gsub("CELESTINAR N ALI", "CELESTINA NALI", df$enumerator)
df$enumerator <- gsub("CLAPERTON", "CLAPERTON KAZUNGU", df$enumerator)
df$enumerator <- gsub("CLAPERTON KAZUNGU KAZUNGU", "CLAPERTON KAZUNGU", df$enumerator)

## Step #2 in protocol at the top of this script 
unique(df$enumerator) # at this point, double check that this list are all individual fishermen 
```

### <a name="Landing_site"></a> **Landing_site and BMU**

### Landing site

```{r}
df$landing_site <- toupper(df$landing_site)
unique(df$landing_site)

## Step #3 in protocol to double check this output list is all the correct site names 
```

### BMU 

```{r}
df$BMU <- toupper(df$BMU)
unique(df$BMU)
## Step #4 in protocol to double check this output list is all the correct BMU names 
```

### <a name="Fisher_info"></a> **Fisher information**

### fisher_phone 

```{r}
## circle back to checking if these are supposed to be a certain # of digits?
```

### household_id

The only issue I can detect here is some lower case vs upper case. 

```{r}
df$household_id <- toupper(df$household_id)
unique(df$household_id)
```

### <a name="trap"></a> **Trap information**

### trap_type 

The only issue I can detect here is some lower case vs upper case. 

```{r}
df$trap_type <- toupper(df$trap_type)
unique(df$trap_type)
```

### total_traps_collected 

View the values put in the df here to double check all values make sense. 

```{r}
total_traps_collected <- df %>% select(total_traps_collected) %>% na.omit()
range(total_traps_collected)

## Step #4 of protocol with new df: double check the below range is expected 
```

### Date and time set; date and time collected

In the first chunk of code, these dates are automatically read in as *dttm* format (date and time). This new columns will be more useful for data analysis later. 

```{r, warning=FALSE}
# making new columns for date and time 
df$date_time_set <- paste(df$date_set_dd_mm_yyyy, df$`time_set_24hh:mm`, sep = " ")
df$date_time_collected <- paste(df$date_collected_dd_mm_yyyy, df$`time_collected_24hh:mm`, sep = " ")

# removing the 'hrs' from observations in this column
df$date_time_set <- gsub("hrs", "", df$date_time_set)
df$date_time_collected <- gsub("hrs", "", df$date_time_collected)

# converting to date and time format 
df$date_time_set <- parse_date_time(df$date_time_set, orders = "ymdHM")
df$date_time_collected <- parse_date_time(df$date_time_collected, orders = "ymdHM")

## any failed to parse error messages will be from rows that do not have a date and time
```

### <a name="catch"></a> **Catch information**

### Weight and value measures 

```{r}
total_weight_kg <- df %>% select(total_weight_kg) %>% na.omit()
take_home_weight_kg <- df %>% select(take_home_weight_kg) %>% na.omit()
total_value_KES <- df %>% select(total_value_KES) %>% na.omit()
take_home_value_KES <- df %>% select(take_home_value_KES) %>% na.omit()

## Step #4 from protocol: Double check the below values are in the correct ranges
range(total_weight_kg)
range(take_home_weight_kg)
range(total_value_KES)
range(take_home_value_KES)
```

### No. of fishers in crew

```{r}
fishermen_no <- df %>% select(`No. of fishers in crew`) %>% na.omit()

## Step #4 from protocol: Double check the below values are in the correct ranges
range(fishermen_no)
```

### Kiswahili_name

```{r}
df$Kiswahili_name <- toupper(df$Kiswahili_name)
unique(sort(df$Kiswahili_name))
```

### SPECIES / Scientific name 

**This is a hard-coding way to do this.. ideally we could downloand a dataset from fishbase and create a compare function that could recognize a name that is a letter or 2 off from a name in fishbase and then create suggestions...** 

We can pull in the validation_lists df to double check these spellings. 

```{r}
# Taking out double spaces in between genus and species 
validation_lists$scientific_name <- gsub("  ", " ", validation_lists$scientific_name)
```

Sorting through df for errors. 

```{r}
# create capitalize function for upper case genus and lower case species 
capitalize_fxn <- function(x){
  first <- toupper(substr(x, start=1, stop=1)) ## capitalize first letter
  rest <- tolower(substr(x, start=2, stop=nchar(x)))   ## everything else lowercase
  paste0(first, rest)
}

df$scientific_name <- capitalize_fxn(df$scientific_name)
validation_lists$scientific_name <- capitalize_fxn(validation_lists$scientific_name)

# Taking out double spaces in between genus and species 
df$scientific_name <- gsub("  ", " ", df$scientific_name)

# Correcting commonly misspelled genus names 
df$scientific_name <- gsub("Acanthrus", "Acanthurus", df$scientific_name)
df$scientific_name <- gsub("Acantrus", "Acanthurus", df$scientific_name)
df$scientific_name <- gsub("Acathurus", "Acanthurus", df$scientific_name)
df$scientific_name <- gsub("Acronthurus", "Acanthurus", df$scientific_name)
df$scientific_name <- gsub("Abdefduf", "Abudefduf", df$scientific_name)
df$scientific_name <- gsub("Cheilo", "Cheilio", df$scientific_name)
df$scientific_name <- gsub("inemis", "inermis", df$scientific_name)
df$scientific_name <- gsub("argentmaculatus", "argentimaculatus", df$scientific_name)
df$scientific_name <- gsub("Cheillinus", "Cheilinus", df$scientific_name)
df$scientific_name <- gsub("candiculatus", "canaliculutus", df$scientific_name)
df$scientific_name <- gsub("canaliculatus", "canaliculutus", df$scientific_name)
df$scientific_name <- gsub("Cholurururs", "Chlorurus", df$scientific_name)
df$scientific_name <- gsub("stronycephalus", "strongylocephalus", df$scientific_name)
df$scientific_name <- gsub("Gymonthorax", "Gymnothorax", df$scientific_name)
df$scientific_name <- gsub("javanicus", "favagineus", df$scientific_name)
df$scientific_name <- gsub("vaiginsis", "vaigiensis", df$scientific_name)
df$scientific_name <- gsub("semicirculatus", "semicirculatus", df$scientific_name)
df$scientific_name <- gsub("semisulcatus", "semicirculatus", df$scientific_name)
df$scientific_name <- gsub("Pomacnathus", "Pomacanthus", df$scientific_name)
df$scientific_name <- gsub("granoculis", "grandoculis", df$scientific_name)
df$scientific_name <- gsub("malanostigma", "melanostigma", df$scientific_name)
df$scientific_name <- gsub("brachycentron", "brachycention", df$scientific_name)
df$scientific_name <- gsub("hard", "harid", df$scientific_name)
df$scientific_name <- gsub("sexfaciatus", "sexfasciatus", df$scientific_name)
df$scientific_name <- gsub("dussumiera", "dussumieri", df$scientific_name)
df$scientific_name <- gsub("caeruleopanctatus", "caeruleopunctatus", df$scientific_name)
df$scientific_name <- gsub("hebei", "heberi", df$scientific_name)
df$scientific_name <- gsub("kippos", "hippos", df$scientific_name)
df$scientific_name <- gsub("Carnx", "Caranx", df$scientific_name)
df$scientific_name <- gsub("coioidea", "coioides", df$scientific_name)
df$scientific_name <- gsub("monochrou", "monochrous", df$scientific_name)
df$scientific_name <- gsub("monochrouss", "monochrous", df$scientific_name)
df$scientific_name <- gsub("Kyphasus", "Kyphosus", df$scientific_name)
df$scientific_name <- gsub("Lenthrinus", "Lethrinus", df$scientific_name)
df$scientific_name <- gsub("Leturinus", "Lethrinus", df$scientific_name)
df$scientific_name <- gsub("vaiguensis", "vaigiensis", df$scientific_name)
df$scientific_name <- gsub("bornonicus", "borbonicus", df$scientific_name)
df$scientific_name <- gsub("nebulosis", "nebulosus", df$scientific_name)
df$scientific_name <- gsub("nebulous", "nebulosus", df$scientific_name)
df$scientific_name <- gsub("Leptoscaus", "Leptoscarus", df$scientific_name)
df$scientific_name <- gsub("fluluiflamma", "fulviflamma", df$scientific_name)
df$scientific_name <- gsub("flavlineathe", "flavolineatus", df$scientific_name)
df$scientific_name <- gsub("taeniourous", "taeniorus", df$scientific_name)
df$scientific_name <- gsub("Navaculichthys", "Novaculichthys", df$scientific_name)
df$scientific_name <- gsub("taeniorus", "taeniourus", df$scientific_name)
df$scientific_name <- gsub("Parupeneus sp nov.", "Parupeneus", df$scientific_name)
df$scientific_name <- gsub("Platux", "Platax", df$scientific_name)
df$scientific_name <- gsub("platyyuna", "platyura", df$scientific_name)
df$scientific_name <- gsub("playfair", "playfairi", df$scientific_name)
df$scientific_name <- gsub("Plectorhincus", "Plectorhinchus", df$scientific_name)
df$scientific_name <- gsub("Plectorhnichus", "Plectorhinchus", df$scientific_name)
df$scientific_name <- gsub("Plotasus", "Plotosus", df$scientific_name)
df$scientific_name <- gsub("Pomatonus", "Pomatomus", df$scientific_name)
df$scientific_name <- gsub("Rhinecanthurus", "Rhineacanthus", df$scientific_name)
df$scientific_name <- gsub("vubroviolaceus", "rubroviolaceus", df$scientific_name)
df$scientific_name <- gsub("sirubroviolaceus", "rubroviolaceus", df$scientific_name)
df$scientific_name <- gsub("Scromberomorus", "Scomerommorus", df$scientific_name)
df$scientific_name <- gsub("Sphraena", "Sphyraena", df$scientific_name)
df$scientific_name <- gsub("meyeri", "meyeni", df$scientific_name)

# correcting spellings in validation list 
validation_lists$scientific_name <- gsub("Gymonthorax", "Gymnothorax", validation_lists$scientific_name)
validation_lists$scientific_name <- gsub("Pomatonus", "Pomatomus", validation_lists$scientific_name)
```

Double checking our df against the valid names so we know what names are typos. 

```{r}
# making df of names that are in the catch_composition (df) but are not in the validation_lists
# these names are typos - fix with gsub functions above 
valid_names <- validation_lists %>% select(scientific_name)
catch_names <- df %>% select(scientific_name)

unvalidated_names <- setdiff(catch_names, valid_names) %>% 
  filter(!scientific_name == "NANA") %>% filter(!scientific_name == "Nana")

unique(sort(unvalidated_names$scientific_name))
```

1.) In catch composition and in fishbase but not on validation list. **Suggested fix: address if these are reasonable to find in Ghana and if they are, keep these entries.**  

- Acanthopagrus berda  
- Acanthurus blochii    
- Acanthurus mata  
- Aethaloperca rogaa  
- Auxis thazard  
- Caranx caninus  
- Caranx heberi  
- Caranx hippos  
- Epinephelus faveatus  
- Epinephelus malabaricus    
- Epinephelus melanostigma  
- Epinephelus spilotoceps   
- Fistularia petimba  
- Gymnothorax flavimarginatus  
- Gymnothorax monochrous  
- Himantura gerrardi  
- Kyphosus bigibbus  
- Monotaxis grandoculis  
- Mugil cephalus  
- Mulloidichthys pfluegeri  
- Myripristis formosa  
- Planiliza alata
- Platybelone platyura
- Plectorhinchus playfairi  
- Plotasus canius
- Pseudorhombus arsius  
- Rhineacanthus aculeatus  
- Sardinella melanura   
- Scomerommorus commerson  
- Siganus fuscescens  
- Siganus guttatus  
- Siganus luridus  
- Thunnus albacares  
- Thysanophrys chiltonae  
- Upeneus japonicus 


2.) In catch composition but not in validation list or on fishbase (not close to a name we have so unsure what it is supposed to be). **Suggested fix: if there is not a clear answer to what these are supposed to be, filter them out.** 

- Cyrnecranius randoculis  
- Lethrinus guttatus  
- Lethrinus vaigiensis  
- Navaculichthys nitaeniourous  
- Ostracion nasus   
- Panulirus versicolor  
- Pomatomus semicirculatus  
- Scarus guttatus  
- Scarus sirubroviolaceus  
- Sepia pharaonis  
- Sphyraena leiura  
- Taeniura meyeni (could be one of two: Taeniura sp. or Taeniurops meyeni)
- Uroteuthis duvaucelii

3.) In validation list but is not on fish base. **No fix needed here, just an FYI.**.   

- Acanthurus vaigiensis

### Length (cm)

This column is a character for because of the "<" and "-". 

1.) 3 observations (rows) have 2 length values and multiple fish. changed these values to NA for now. 

- "16-20   ,46-50"    
- "26-30,21- 25"   

2.) Many operations by CLAPERTON KAZUNGU include a length value of 4488 which is not realistic so I changed these to NA for now. 

3.) Some ranges weren't correct like "16-25" and only have <10 observations like that so I changed them to the nearest possible category. e.g. "16-25" to "16-20". "21-30" to "21-25". 


```{r}
## viewing those that have two observations in one row (should have been 2 rows)
df %>% filter(length_cm == "16-20   ,46-50" | length_cm == "26-30,21- 25")

## viewing what observation have a really high value  
## many operations by CLAPERTON KAZUNGU include a length value of 44880
df %>% filter(length_cm == "NA")

# converting length values to NA that don't make sense
df$length_cm <- gsub("44880", "NA", df$length_cm)
df$length_cm <- gsub("16-20   ,46-50", "NA", df$length_cm)
df$length_cm <- gsub("26-30,21- 25", "NA", df$length_cm)

# fixing the < and > mix-up 
df$length_cm <- gsub("<75", ">75", df$length_cm)

# converting <10 to a range of 0-10 
df <- df %>% 
  mutate(length_cm = if_else(length_cm == "<10", "0-10", length_cm))

# converting ranges that don't make sense 
df$length_cm <- gsub("31-15", "31-35", df$length_cm)
df$length_cm <- gsub("10-15", "11-15", df$length_cm)
df$length_cm <- gsub("31-37", "31-35", df$length_cm)
df$length_cm <- gsub("31-36", "31-35", df$length_cm)
df$length_cm <- gsub("16-25", "16-20", df$length_cm)
df$length_cm <- gsub("21-30", "21-25", df$length_cm)
df$length_cm <- gsub("26-35", "26-30", df$length_cm)

# converting numerical values to ranges 
df <- df %>% 
 mutate(length_corrected = case_when(
    length_cm >= 0 & length_cm <= 10.5 ~ "0-10",
    length_cm >= 10.5 & length_cm <= 15.4 ~ "11-15",
    length_cm >= 15.5 & length_cm <= 20.4 ~ "16-20",
    length_cm >= 20.5 & length_cm <= 25.4 ~ "21-25",
    length_cm >= 25.5 & length_cm <= 30.4 ~ "26-30",
    length_cm >= 30.5 & length_cm <= 35.4 ~ "31-35",
    length_cm >= 35.5 & length_cm <= 40.4 ~ "36-40",
    length_cm >= 40.5 & length_cm <= 45.4 ~ "41-45",
    length_cm >= 45.5 & length_cm <= 50.4 ~ "46-50",
    length_cm >= 50.5 & length_cm <= 75 ~ ">50",
    length_cm > 75 ~ ">75"))

# double checking that worked for the corrected column 
unique(sort(df$length_cm))
unique(sort(df$length_corrected))
```

Correct output for length_corrected: `">50"   ">75"   "0-10"  "11-15" "16-20" "21-25" "26-30" "31-35" "36-40" "41-45" "46-50"`. 

## <a name="gear"></a> **Gear type, and fish numbers/final destination**

### Gear type 

Double check that this list looks right. Left off at looking at this list and then 

```{r}
df$`gear type` <- toupper(df$`gear type`)

df$`gear type` <- gsub("MONOFILLAMENT", "MONOFILAMENT", df$`gear type`)
df$`gear type` <- gsub("UNMODIFIED TRAP", "UNMODIFIED", df$`gear type`)
df$`gear type` <- gsub("MODIFIED TRAP", "MODIFIED", df$`gear type`)

unique(sort(df$`gear type`))
```

### Number of fish 

Doube check this range is what is expected. 

```{r}
unique(sort(df$number_of_fish))
```

### Destination of fish

```{r}
df$destination <- toupper(df$destination)

df <- df %>%
  filter(!destination == "OTHER WRITE IN:")

df$destination <- gsub("OTHER WRITE IN:", "", df$destination)

unique(sort(df$destination))
```

## <a name="notes"></a> **Final check: any notes from both datasets**


```{r}
## check for any notes that the data collectors left for analysis 
unique(df$fishing_operation_notes)
unique(df$catch_composition_notes)
```

## <a name="export"></a> **Exporting cleaned dataset**

```{r}
head(df)
nrow(df)

write_xlsx(df, "data/Fishlandings-cleaned-21052022-May.xlsx")
```


