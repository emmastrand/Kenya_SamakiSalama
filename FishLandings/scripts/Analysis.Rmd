---
title: "Analysis of Fishing Landings dataset"
author: "Author: Emma Strand; emma_strand@uri.edu"
output:
  github_document: default
  pdf_document:
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Prior Scripts 

QC: https://github.com/emmastrand/Kenya_SamakiSalama/blob/main/FishLandings/scripts/QC.md 

## <a name="data"></a> **Reading in datafiles**

```{r, message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(readxl)
library(lubridate)
library(Hmisc)
library(writexl)
library(naniar)
library(Rmisc)
library(stats)
library(lme4)
library(car)
library(forcats)
library(ggstatsplot)
library(ggridges)
```

## Read in the data frame that is the output of the QC script. 

Summary information so far: 741 total surveys, 591 unmodified traps, 150 modified traps. 

```{r, message=FALSE, warning=FALSE}
# read in excel file
## 4,508 rows x 25 variables (this should match the final version of QC script)
data <- read_excel("data/cleaned-Fishlandings-data-FEB 2023 JMCC.xlsx") #read in excel file 

# creating new columns with month year and date
## survey ID is master identifier that is based on `date_collected_dd_mm_yyyy` column 
data <- data %>% 
  separate(date_collected_dd_mm_yyyy, c("year", "month", "day"), remove = FALSE) 

#changing this column to numeric instead of a character (needed for next fxn)
data$month <- as.numeric(data$month) 
#changing numeric months to month names
data$month <- month.abb[data$month] 
# changing levels of month (important for figures later on); only first three letter of month 
data$month <- factor(data$month, levels=c("Jan", "Feb","Mar","Apr","May","Jun",
                                          "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
```

## Metadata summary information

**Modified traps Uyombo, Mayungu (BMUs)**
- 150 surveys
- 2021: September, August, November   
- 2022: February, March, April   
- Data collected by: CLAPERTON KAZUNGU, CELESTINE N. ALI, KADZO BAYA  
- Four landing sites: UYOMBO, MAYUNGU, MAWE YA KATI, KIVULINI
- 49 fishers involved / 69 fishers total 
- Destinations: Fish dealer, Home, Mama Karanga

**Unmodified traps in Uyombo, Mayungu (BMUs)**   
- 591 surveys 
- 2021: May, June, July, August, September, October, November, December   
- 2022: February, March, April   
- Data collected by: CLAPERTON KAZUNGU, CELESTINE N. ALI, KADZO BAYA  
- Four landing sites: UYOMBO, MAYUNGU, MAWE YA KATI, KIVULINI
- 64 fishers involved / 69 fishers total 
- Destinations: Fish dealer, Home, Mama Karanga, Gift, Other

```{r}
## modified: 546 rows from 150 unique surveys 
## unmodified: 3,962 rows from 591 surveys 

unmodified_metadata <- data %>% subset(trap_type == "UNMODIFIED") %>%
  unite(yearmonth, year, month, sep = " ", remove = FALSE)

modified_metadata <- data %>% subset(trap_type == "MODIFIED") %>%
  unite(yearmonth, year, month, sep = " ", remove = FALSE)

unique(modified_metadata$destination)
unique(unmodified_metadata$survey_id)
```


## Check ranges and add filters 

79 unique species total: 31 of those found in modified traps and 78 of those found in unmodified traps 

```{r}
range(data$total_traps_collected) ## 1-16 traps used 
range(data$total_biomass_kg) ## 0.3 kg - 24 kg 
range(data$total_value_KES) ## 60 KES - 4800 KES 
range(data$`No. of fishers in crew`) ## 1 - 6 fishermen involved with 1 representative survey per catch 
range(data$number_of_fish) ## 1 - 19 fish caught per species caught 

unique(data$length_corrected)
#unique(data$scientific_name)
#unique(unmodified_metadata$scientific_name)
```

### Editing modified and unmodified to experimental and control traps 

```{r}
data <- data %>%
  mutate(trap_type = case_when(
    trap_type == "MODIFIED" ~ "Experimental",
    trap_type == "UNMODIFIED" ~ "Control"))
```

### Additional filtering of non-realistic data 

1. Survey id `2022-02-11 12:37:00 SS/MAY/SB/035/FF` appears to set trap and collect at the same time in 2 locations so removing the location with the non-realistic CPUE of above 40. 

```{r}
## PRE FILTER 4,508 rows
## POST FILTER 4,498 rows (confirmed only the below was taken outs)
data <- data %>% 
  subset(!landing_site == "MAYUNGU" | !survey_id == "2022-02-11 12:37:00 SS/MAY/SB/035/FF")
```

## Calculating total catch per trap (CPUE)

```{r}
data2 <- data %>%
  # group by survey id
  dplyr::group_by(survey_id, trap_type) %>% 
  # count the number of fish caught for each survey id
  mutate(total_catch = sum(number_of_fish),
  # catch per unit effort (# of traps)
         CPUE = total_catch/total_traps_collected)

range(data2$total_catch) ## 1 - 114 fish 
range(data2$CPUE) ## 0.25 - 16.00 fish per trap 

CPUE_plot <- data2 %>% dplyr::select(survey_id, trap_type, CPUE) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=CPUE)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/CPUE.png", CPUE_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

Default of t.test in R is a Welch t-test which is just an adaptation of t-test, and it is used when the two samples have possibly unequal variances. Use var.equal = TRUE or FALSE to specifiy the variances of the dataset. 

You can test equal variances with a Fisher's F-test. If p < 0.05 then we include var.equal = FALSE in below ttest. If p > 0.05 then we include var.equal = TRUE in below ttest.

```{r}
data2_CPUE <- data2 %>% dplyr::select(survey_id, trap_type, CPUE) %>% distinct()

exp_CPUE <- data2_CPUE %>% subset(trap_type == "Experimental") ## 150 data points
con_CPUE <- data2_CPUE %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_CPUE$CPUE, con_CPUE$CPUE) 
## p-value = 0.0196; ratio = 0.7288769
t.test(CPUE~trap_type, data = data2_CPUE, var.equal = FALSE)
## p-value = 0.5434 

CPUE_per_trap_stats <- summarySE(data2_CPUE, measurevar = c("CPUE"), groupvars = c("trap_type"))

# CPUE_plot2 <- data2_CPUE %>% 
#   ggplot(., aes(x=trap_type, y=CPUE)) + 
#   geom_jitter(size=1, alpha=0.5, width=0.2) + theme_classic() + #ylim(2.5,3.5) +
#   geom_point(data=CPUE_per_trap_stats, aes(x=trap_type, y=CPUE), size=4) +
#   geom_errorbar(data=CPUE_per_trap_stats, aes(ymin=CPUE-se, ymax=CPUE+se), size=0.5, width=.2)
# 
# ggsave(file="output/CPUE2.png", CPUE_plot2, width = 3, height = 3.5, units = c("in"))
```

## Calculating (reported) yield per trap 

```{r}
data2 <- data2 %>%
  ## this df is still grouped by survey id and trap type 
  # reported yield (kg) per unit effort (# of traps)
  mutate(yield_kg_trap = total_biomass_kg/total_traps_collected)

range(data2$yield_kg_trap) ## 0.057 kg - 5.25 kg 

yield_kg_plot <- data2 %>% dplyr::select(survey_id, trap_type, yield_kg_trap) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=yield_kg_trap)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Yield.png", yield_kg_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data2_yieldkg <- data2 %>% dplyr::select(survey_id, trap_type, yield_kg_trap) %>% distinct()

exp_yieldkg <- data2_yieldkg %>% subset(trap_type == "Experimental") ## 150 data points
con_yieldkg <- data2_yieldkg %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_yieldkg$yield_kg_trap, con_yieldkg$yield_kg_trap) 
## p-value = 0.9069; ratio = 0.981616
t.test(yield_kg_trap~trap_type, data = data2_yieldkg, var.equal = TRUE)
## p-value = 0.0433 

yieldkg_per_trap_stats <- summarySE(data2_yieldkg, measurevar = c("yield_kg_trap"), groupvars = c("trap_type"))
```


## Calculating (reported) value per trap 

```{r}
data2 <- data2 %>%
  ## this df is still grouped by survey id and trap type 
  # reported value (KES) per unit effort (# of traps)
  mutate(value_KES_trap = total_value_KES/total_traps_collected)

range(data2$value_KES_trap) ## 11.42 KES - 1150 KES 

value_KES_plot <- data2 %>% dplyr::select(survey_id, trap_type, value_KES_trap) %>% distinct() %>%
  filter(value_KES_trap < 1000) %>%
  ggplot(., aes(x=trap_type, y=value_KES_trap)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Value.png", value_KES_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data2_valueKES <- data2 %>% dplyr::select(survey_id, trap_type, value_KES_trap) %>% distinct()

exp_valueKES <- data2_valueKES %>% subset(trap_type == "Experimental") ## 150 data points
con_valueKES <- data2_valueKES %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_valueKES$value_KES_trap, con_valueKES$value_KES_trap) 
## p-value = 0.8557; ratio = 0.9733375
t.test(value_KES_trap~trap_type, data = data2_valueKES, var.equal = TRUE)
## p-value = 0.03236 

valueKES_per_trap_stats <- summarySE(data2_valueKES, measurevar = c("value_KES_trap"), groupvars = c("trap_type"))
```

## Calculating median length 

```{r}
data2 <- data2 %>% ungroup() %>%
  mutate(median_length = case_when(
    length_corrected == "0-10" ~ 5,
    length_corrected == "11-15" ~ 13,
    length_corrected == "16-20" ~ 18,
    length_corrected == "21-25" ~ 23,
    length_corrected == "26-30" ~ 28,
    length_corrected == "31-35" ~ 33,
    length_corrected == "36-40" ~ 38,
    length_corrected == "41-45" ~ 43,
    length_corrected == "46-50" ~ 48,
    length_corrected == "51-60" ~ 55.5,
    length_corrected == "61-70" ~ 65.5,
    length_corrected == "71-80" ~ 75.5,
    length_corrected == "81-90" ~ 85.5,
    length_corrected == ">90" ~ 100 ### circle back to what value to use here
  )) 

hist(data2$median_length) ## majority fall within 10-40 cm 

length_plot <- data2 %>%
  dplyr::select(survey_id, trap_type, median_length) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=median_length)) + geom_boxplot(outlier.shape = NA) + theme_bw()
 # geom_point(alpha=0.1, size=0.4, color="gray50") 

ggsave(file="output/Length.png", length_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data2_length <- data2 %>% dplyr::select(survey_id, trap_type, scientific_name, number_of_fish, median_length) %>% 
  ### transforms so that e.g. 14 siganus sutor is now 14 rows
  tidyr::uncount(., number_of_fish, .remove = TRUE) %>% 
  filter(!is.na(median_length))

exp_length <- data2_length %>% subset(trap_type == "Experimental") ## 2,428 data points (many fish per survey)
con_length <- data2_length %>% subset(trap_type == "Control") ## 15,396 data points (many fish per survey)

var.test(exp_length$median_length, con_length$median_length) 
## p-value < 2.2e-16; ratio = 0.7128101
t.test(median_length~trap_type, data = data2_length, var.equal = FALSE)
## p-value < 2.2e-16

length_stats <- summarySE(data2_length, measurevar = c("median_length"), groupvars = c("trap_type"))
```

## Calculating take home metrics 

```{r}
data2 <- data2 %>% dplyr::group_by(survey_id, destination) %>%
  mutate(no_perdestination = sum(number_of_fish),
         percent_perdestination = no_perdestination/total_catch*100)

data2_takehome <- data2 %>% 
  dplyr::select(survey_id, trap_type, destination, percent_perdestination) %>% 
  distinct() %>% subset(destination == "HOME")

takehome_stats <- summarySE(data2_takehome, measurevar = c("percent_perdestination"), groupvars = c("trap_type"))

exp_takehome <- data2_takehome %>% subset(trap_type == "Experimental") ## 40 data points (multiple destinations)
con_takehome <- data2_takehome %>% subset(trap_type == "Control") ## 352 data points (multiple destinations)

var.test(exp_takehome$percent_perdestination, con_takehome$percent_perdestination) 
## p-value < 2.2e-16; ratio = 3.386456
t.test(percent_perdestination~trap_type, data = data2_takehome, var.equal = FALSE)
## p-value 0.002949

takehome_plot <- data2_takehome %>% 
  ggplot(., aes(x=trap_type, y=percent_perdestination)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Take_Home.png", takehome_plot, width = 3, height = 3.5, units = c("in"))
```


## Calculating species data

73 total species of fish caught (`species_list` is output). 31 species from 12 families found in experimental traps. 72 species from 18 families found in control traps. 

Produces species counts for each type of trap. Top 5:

**Control** for 591 surveys
1: Siganus sutor (6,963)  
2: Leptoscarus vaigiensis (1,887)  
3: Lethrinus nebulosus (1,074)  
4: Scarus ghobban (1,042) 
5: Scarus rubroviolaceus (765) 

**Experimental** for 150 surveys 
1: Siganus sutor (1,818)
2: Scarus ghobban (124) 
3: Lethrinus nebulosus (113) 
4: Siganus canaliculatus (84)
5: Parupeneus macronemus (50) 

```{r}
spp_df <- data2 %>% ungroup() %>%
  group_by(scientific_name, trap_type) %>%
  ## this df is still grouped by survey id and trap type 
  # reported value (KES) per unit effort (# of traps)
  mutate(spp_count = sum(number_of_fish)) %>% 
  dplyr::select(scientific_name, trap_type, spp_count) %>% distinct() %>% ungroup()

spp_df_mod <- spp_df %>% subset(trap_type == "Experimental") %>% dplyr::select(scientific_name) %>% distinct()
spp_df_unmod <- spp_df %>% subset(trap_type == "Control") %>% dplyr::select(scientific_name) %>% distinct()

species_list <- spp_df %>% dplyr::select(scientific_name) %>% distinct()
species_list %>% write.csv("data/full_species_list.csv")
```

## Loading Galligan and FishBase dataset 

Most species in the list above have metadata below. 

```{r}
fishbase_lifehistory <- read_excel("data/fishbase.xlsx", sheet = "life history") %>% #read in excel file 
  select(scientific_name, Lm, Lmax) %>% dplyr::rename(Lmat_fishbase = Lm) %>% dplyr::rename(Lmax_fishbase = Lmax) 

# rows that appear in species_list but not fishbase_lifehistory
## checking which fish I still need Fishbase information for (44 species)
# dplyr::setdiff(species_list, fishbase_lifehistory) %>% write.csv("data/add_fishbase_info.csv")

fishbase_biomass <- read_excel("data/fishbase.xlsx", sheet = "biomass") %>%
  dplyr::select(scientific_name, a, b)

fishbase <- full_join(fishbase_lifehistory, fishbase_biomass, by = "scientific_name")

galligan <- read.csv("data/SpeciesData_GatedTraps_Galligan_edited.csv", header=TRUE, sep = ",") %>%
  dplyr::rename(scientific_name = Species) #%>% dplyr::select(., scientific_name)
# dplyr::setdiff(species_list, galligan) 
### 11 fish found in our dataset that are not found in Galligan dataset 
## these won't be included in the nutrient or revenue analysis
## I think this is OK b/c all species have 113 or lower than 40 total catch

metadata <- full_join(fishbase, galligan, by = "scientific_name")
```

### Calculating number of families that appear in each type of trap 

```{r}
left_join(spp_df_unmod, metadata, by = "scientific_name") %>%
  dplyr::select(Family) %>% distinct() %>% na.omit()
## 18 families caught in control traps 

left_join(spp_df_mod, metadata, by = "scientific_name") %>%
  dplyr::select(Family) %>% distinct() %>% na.omit()
## 12 families caught in experimental traps 
```

### Calculating species richness 

```{r}
data2 <- data2 %>% group_by(survey_id) %>%
  mutate(richness = n_distinct(scientific_name))

range(data2$richness) ## 1 - 14 different species in one survey 

richnessdf <- data2 %>% dplyr::select(survey_id, BMU, trap_type, richness) %>% distinct()
length_stats <- summarySE(richnessdf, measurevar = c("richness"), groupvars = c("trap_type", "BMU"))

richness_plot <- length_stats %>%
  ggplot(., aes(x=trap_type, y=richness, color=BMU)) + theme_bw() +
  geom_point(size=2) +
  #geom_bar(stat="identity", position = "dodge") +
  geom_errorbar(aes(x=trap_type, y=richness, ymin=richness-se, ymax=richness+se), alpha=0.9, size=0.5, width=0.1)

ggsave(file="output/Richness.png", richness_plot, width = 5, height = 3.5, units = c("in"))

richness_aov <- aov(richness~trap_type*BMU, data=richnessdf)
summary(richness_aov)
TukeyHSD(richness_aov)
```

## Calculating maturity 

**Control traps**:  
- 6,492 mature fish caught (42.2%) and 8,890 immature fish caught (57.8%)

**Experimental traps**:  
- 1,561 mature fish caught (64.3%) and 867 immature fish caught (35.7%)

```{r}
## data2 pre merge = 4,498 x 31
## data2 post merge = 4,498 x 78 [with left join this only keep metadata for fish found in our surveys]
## metadata 227 x 48 columns 
data2 <- left_join(data2, metadata, by = "scientific_name")

## We have Lmat from Galligan and Lmat from Fishbase -- confirm with Austin which one to use 
data2 <- data2 %>% 
  ### categorizing mature or immature 
  mutate(maturity = if_else(median_length >= Lmat_fishbase, "mature", "immature")) %>%
  ### calculating distance from Lmat
  mutate(length_dist = median_length-Lmat_fishbase) 

## calculating total numbers for stats above 
data2 %>% dplyr::select(survey_id, trap_type, scientific_name, number_of_fish, maturity) %>% 
  group_by(trap_type, maturity) %>% 
  filter(!is.na(maturity)) %>%
  mutate(sum = sum(number_of_fish)) %>%
  dplyr::select(trap_type, maturity, sum) %>% distinct()

## calculating stats for distance from maturity 
data2_maturity <- data2 %>% dplyr::select(survey_id, trap_type, scientific_name, number_of_fish, maturity, length_dist) %>%
  tidyr::uncount(., number_of_fish, .remove = TRUE) %>% 
  filter(!is.na(length_dist))
```

### Calculating statistics for distance from maturity 

```{r}
exp_maturity <- data2_maturity %>% subset(trap_type == "Experimental") ## 2,428 data points (many fish per survey)
con_maturity <- data2_maturity %>% subset(trap_type == "Control") ## 15,386 data points (many fish per survey)

var.test(exp_maturity$length_dist, con_maturity$length_dist) 
## p-value < 2.2e-16; ratio = 0.7075884

data2_maturity_mature <- data2_maturity %>% subset(maturity == "mature")
data2_maturity_immature <- data2_maturity %>% subset(maturity == "immature")

t.test(length_dist~trap_type, data = data2_maturity_mature, var.equal = FALSE)
## p-value < 2.2e-16
t.test(length_dist~trap_type, data = data2_maturity_immature, var.equal = FALSE)

maturity_stats <- summarySE(data2_maturity, measurevar = c("length_dist"), 
                            groupvars = c("trap_type", "scientific_name")) %>%
  filter(!N<3)
```

### Constructing maturity figure

```{r}
maturity_plot <- maturity_stats %>%
  # filters out the observations aren't in both categories 
  # (takes out species that only have 1 unique mean dist value so only 1 trap type)
  group_by(scientific_name) %>%
  dplyr::filter(n_distinct(length_dist) >= 2) %>% 
  ungroup() %>%
  ggplot(., aes(x=fct_rev(scientific_name), y=length_dist, fill=trap_type)) + 
  coord_flip() +
  scale_fill_manual(values = c("black", "white")) +
  geom_hline(yintercept = 0, lty = "dotted") +
  theme(axis.text.x = element_text(face = "italic"),
        axis.text.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  geom_line(aes(group = scientific_name), color="grey14") +
  geom_point(size=2, shape=21) + theme_bw() + 
  #geom_errorbar(aes(x=trap_type, y=length_dist, ymin=length_dist-se, ymax=length_dist+se)) +
  labs(y="Distance from Lmat (cm)", x="", fill="Trap Type") 

ggsave(file="output/Maturity.png", maturity_plot, width = 7, height = 6, units = c("in"))
```

## Calculating length frequency distribution 

```{r}
# re factoring the length column 
data2$length_corrected <- factor(data2$length_corrected, levels=c("0-10", "11-15","16-20","21-25","26-30",
                                                                        "31-35","36-40","41-45", "46-50", "51-60",
                                                                        "61-70", "71-80", "81-90", ">90"))

## creating dataframe for length frequency 
data2_length_frequency <- data2 %>% 
  select(survey_id, trap_type, scientific_name, number_of_fish, length_corrected, median_length, 
         maturity, Lmat_fishbase) %>%
  subset(trap_type == "Control") %>%
  #subset(trap_type == "Experimental") %>%
  subset(scientific_name == "Siganus sutor" | 
           scientific_name == "Scarus ghobban" |
           scientific_name == "Lethrinus nebulosus" |
           scientific_name == "Scarus rubroviolaceus" |
           scientific_name == "Siganus canaliculatus") %>% 
  tidyr::uncount(., number_of_fish, .remove = TRUE) %>% 
  group_by(scientific_name) %>%
  #dplyr::filter(n_distinct(trap_type) >= 2) %>% 
  ungroup()

length_frequency_plot <- data2_length_frequency %>% 
  ggplot(aes(x=length_corrected, fill=trap_type)) +
    geom_histogram(color="black", alpha=0.6, position = 'identity', stat="count") +
    scale_fill_manual(values=c("grey80")) + ### grey60 for control; white for experimental 
    theme_classic() +
    labs(fill="") +
    facet_grid(scientific_name~trap_type, scales = "free") +
    theme_bw() + xlab("Length (cm)") + ylab("Frequency") +
  theme(axis.text.x.bottom = element_text(colour = 'black', angle = 60, hjust = 1),
        axis.text.y = element_text(colour = 'black', size = 8, face = 'italic'),
        panel.border = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
        strip.text.x = element_text(size = 9, color = "black", face = "bold.italic"),
        axis.line = element_line(colour = "black"),
        axis.title.y = element_text(size = 12, face = "bold", margin = margin(t = 0, r = 10, b = 0, l = 0)),
        axis.title.x = element_text(size = 12, face = "bold", margin = margin(t = 10, r = 0, b = 0, l = 0))) 

ggsave(file="output/Length_frequency_control.png", length_frequency_plot, width = 5, height = 8, units = c("in"))
```

### Calculating % fish underneath Lm and sample size per trap type for the figure below 

**Siganus sutor**:   
- Control: 59.13% immature (below Lmat)
- Experimental: 27.50% immature (below Lmat)

**Siganus canaliculatus**: 
- Control: 12.98% immature (below Lmat)
- Experimental: 0% immature (below Lmat)

**Scarus rubroviolaceus**:
- Control: 55.42% immature (below Lmat)
- Experimental: 5.88% immature (below Lmat)

**Scarus ghobban**: 
- Control: 91.36% immature (below Lmat)
- Experimental: 92.74% immature (below Lmat)

**Lethrinus nebulosus**:
- Control: 99.53% immature (below Lmat)
- Experimental: 98.23% immature (below Lmat)


```{r}
maturity_calcs <- data2_length_frequency %>%
  group_by(scientific_name, trap_type) %>%
  mutate(sample_size = n(),
         count_below = sum(median_length <= Lmat_fishbase, na.rm=TRUE),
         percent_below = (count_below/sample_size)*100) %>%
 select(scientific_name, trap_type, sample_size, 
         count_below, percent_below) %>% 
  ungroup() %>% distinct()

# double checking the above calculation worked
## cross reference output against dataframe above. 
data2_length_frequency %>% 
  filter(scientific_name == "Siganus sutor", trap_type == "Control") %>%
  count(maturity == "immature") 
```

## Calculating Biomass 

W=aL^b 

W = Biomass  
L = Length (in our case, median length)  
a = (taken from fishbase)
b = (taken from fishbase)

Read in data from fishbase. These units are in cm and grams. 

https://www.fishbase.de/manual/English/FishbaseThe_LENGTH_WEIGHT_table.htm

```{r}
### Switching to data3 which will filter out those fish with no nutrient or a and b values 
data3 <- data2 %>% ungroup() %>%
  ## mutating a and b column to be numeric; this will create NAs b/c not all fish had a and b valueus in fishbase
  mutate_at(c('a', 'b'), as.numeric) %>%
  mutate(W_g = (a*(median_length^b))*number_of_fish,
         W_kg = W_g/1000) %>%
  group_by(survey_id) %>%
  filter(!is.na(W_kg)) %>%
  mutate(calculated_total_biomass = sum(W_kg),
         calculated_biomass_pertrap = calculated_total_biomass/total_traps_collected) %>% 
  ungroup()
```

### Comparing reported vs. calculated 

```{r}
data3 %>% 
  select(survey_id, total_biomass_kg, calculated_total_biomass) %>%
  distinct() %>% na.omit() %>%
  mutate(comparison = if_else(total_biomass_kg > calculated_total_biomass, "REPORTED > CALC", "REPORTED < CALC"),
         difference = total_biomass_kg-calculated_total_biomass) %>%
  ggplot(., aes(x=comparison, y=difference)) + theme_bw() +
  geom_jitter(aes(color=comparison), size=1) + xlab("") + ylab("difference in value")
```

### Calculated biomass values per trap 

```{r}
range(data3$calculated_biomass_pertrap) ## 0.03890296 kg - 23.11299675 kg 

calculated_kg_plot <- data3 %>% dplyr::select(survey_id, trap_type, calculated_biomass_pertrap) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=calculated_biomass_pertrap)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Yield_calculated.png", calculated_kg_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data3_calculated_yield <- data3 %>% dplyr::select(survey_id, trap_type, calculated_biomass_pertrap) %>% distinct()

exp_calculated_yield <- data3_calculated_yield %>% subset(trap_type == "Experimental") ## 150 data points
con_calculated_yield <- data3_calculated_yield %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_calculated_yield$calculated_biomass_pertrap, con_calculated_yield$calculated_biomass_pertrap) 
## p-value < 2.2e-16; ratio = 6.97762
t.test(calculated_biomass_pertrap~trap_type, data = data3_calculated_yield, var.equal = FALSE)
## p-value = 7.753e-07

calculated_yield_per_trap_stats <- summarySE(data3_calculated_yield, 
                                     measurevar = c("calculated_biomass_pertrap"), groupvars = c("trap_type"))
```

## Calculating economic data 

Each species group has a KSH per kg value. 

```{r}
data3 <- data3 %>% 
  ### 1. calculate each species group price 
  mutate(KSHperspp = Price_KSHPerkg*W_kg) %>% group_by(survey_id) %>%
  filter(!is.na(KSHperspp)) %>%
  ### 2. calculate total value per survey 
  mutate(KSHpersurvey = sum(KSHperspp), na.rm=TRUE) %>% ungroup() %>%
  ### 3. Divide by total traps collected in that survey to get per trap 
  mutate(KSHpertrap = KSHpersurvey/total_traps_collected, na.rm=TRUE)

range(data3$KSHpertrap) ## 7.404932 KES - 3644.143016 KES 

calculated_value_plot <- data3 %>% dplyr::select(survey_id, trap_type, KSHpertrap) %>% distinct() %>%
  filter(KSHpertrap < 1000) %>%
  ggplot(., aes(x=trap_type, y=KSHpertrap)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Value_calculated.png", calculated_value_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data3_calculated_value <- data3 %>% dplyr::select(survey_id, month, trap_type, KSHpertrap) %>% distinct()

exp_calculated_value <- data3_calculated_value %>% subset(trap_type == "Experimental") ## 150 data points
con_calculated_value <- data3_calculated_value %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_calculated_value$KSHpertrap, con_calculated_value$KSHpertrap) 
## p-value < 2.2e-16; ratio = 6.499281
t.test(KSHpertrap~trap_type, data = data3_calculated_value, var.equal = FALSE)
## p-value = 2.145e-08

calculated_value_per_trap_stats <- summarySE(data3_calculated_value, 
                                     measurevar = c("KSHpertrap"), groupvars = c("trap_type"))

calculated_value_per_trap_stats_permonth <- summarySE(data3_calculated_value, 
                                     measurevar = c("KSHpertrap"), groupvars = c("trap_type", "month"))

revenue_plot <- calculated_value_per_trap_stats_permonth %>% 
  ggplot(., aes(x=month, y=KSHpertrap, lty=trap_type)) +  
  #scale_color_manual(values = c( "#387780", "#FF8C61")) +
  #scale_fill_manual(values = c( "#387780", "#FF8C61")) +
  theme_bw() + xlab("Month") + ylab("Revenue (KSH trap-1)") +
  geom_line(data=calculated_value_per_trap_stats_permonth, aes(group = trap_type), size=0.5) +
  geom_point(data = calculated_value_per_trap_stats_permonth, aes(x=month, y=KSHpertrap), size=1) +
  geom_errorbar(data = calculated_value_per_trap_stats_permonth, 
                aes(ymin=KSHpertrap-se, ymax=KSHpertrap+se), size=0.5, width=.2)

ggsave(file="output/Revenue.png", revenue_plot, width = 5.5, height = 3.5, units = c("in"))
```

## Calculating nutritional yield 

```{r}
### to calculate nutrient components per group of fish per survey 
## W_g = calculated biomass (g)
## Nutrient_mgPer100g 
## (W_g/100)*Nutrient_mgPer100g = nutrientmg for that group of fish in that survey 

data3 <- data3 %>%
  mutate(spp_Calcium = (W_g/100)*Calcium_mgPer100g,
         spp_Iron = (W_g/100)*Iron_mgPer100g,
         spp_Omega3 = (W_g/100)*Omega3_gPer100g,
         spp_Protein = (W_g/100)*Protein_gPer100g,
         spp_VitaminA = (W_g/100)*VitaminA_ugPer100g,
         spp_Selenium = (W_g/100)*Selenium_ugPer100g,
         spp_Zinc = (W_g/100)*Zinc_mgPer100g) %>% 
  # calculating total nutrient for each survey 
  dplyr::group_by(survey_id) %>%
  mutate(pertrap_Calcium = sum(spp_Calcium)/total_traps_collected,
         pertrap_Iron = sum(spp_Iron)/total_traps_collected,
         pertrap_Omega3 = sum(spp_Omega3)/total_traps_collected,
         pertrap_Protein = sum(spp_Protein)/total_traps_collected,
         pertrap_VitaminA = sum(spp_VitaminA)/total_traps_collected,
         pertrap_Selenium = sum(spp_Selenium)/total_traps_collected,
         pertrap_Zinc = sum(spp_Zinc)/total_traps_collected) %>% ungroup() %>%
  ## plotted outliers below and decided to exclude outliers 
  filter(pertrap_Calcium < 3000) %>%
  filter(pertrap_Iron < 75) %>%
  filter(pertrap_VitaminA < 3000) 
```

### Plotting individual nutrients 

```{r}
nutrient_individual_plot <- data3 %>% dplyr::select(survey_id, trap_type, pertrap_Protein) %>% 
  distinct() %>%
  ggplot(., aes(x=trap_type, y=pertrap_Protein)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + 
  theme_bw()

ggsave(file="output/Nutrient_Protein.png", nutrient_individual_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above 

```{r}
nutrient_stats <- data3 %>% 
  select(survey_id, pertrap_Calcium, pertrap_Iron, pertrap_Omega3, 
         pertrap_Protein, pertrap_VitaminA, pertrap_Selenium, pertrap_Zinc, trap_type) %>% 
  distinct() %>% na.omit()

### replace variable name below for each t.test 
t.test(pertrap_Zinc~trap_type, data = nutrient_stats, var.equal = FALSE)

calcium_stats <- summarySE(nutrient_stats, measurevar = c("pertrap_Calcium"), groupvars = c("trap_type"))
iron_stats <- summarySE(nutrient_stats, measurevar = c("pertrap_Iron"), groupvars = c("trap_type"))
omega3_stats <- summarySE(nutrient_stats, measurevar = c("pertrap_Omega3"), groupvars = c("trap_type"))
protein_stats <- summarySE(nutrient_stats, measurevar = c("pertrap_Protein"), groupvars = c("trap_type"))
vitaminA_stats <- summarySE(nutrient_stats, measurevar = c("pertrap_VitaminA"), groupvars = c("trap_type"))
selenium_stats <- summarySE(nutrient_stats, measurevar = c("pertrap_Selenium"), groupvars = c("trap_type"))
zinc_stats <- summarySE(nutrient_stats, measurevar = c("pertrap_Zinc"), groupvars = c("trap_type"))
```

## Calculating bycatch 

399 instances of bycatch (% of total catch). 85% of that bycatch occured in controlled traps (341 bycatch fish caught in control and 58 in experimental). 

17 species of bycatch fish caught: 
- *Acanthurus triostegus*, *Acanthurus nigricauda*, *Acanthurus nigrofuscus*, *Abudefduf sexfasciatus*, *Balistapus undulatus*  
- *Cephalopholis spiloparaea*, *Chaetodon auriga*, *Chaetodon kleinii*, *Cheilinus trilobatus*, *Epinephelus fuscoguttatus*  
- *Heniochus acuminatus*, *Naso annulatus*, *Naso brachycentron*, *Naso hexacanthus*, *Naso unicornis*  
- *Novaculichthys taeniourus*, *Plectorhinchus flavomaculatus*

```{r}
### POST FILTERS ABOVE = 4,129 
data3 %>% dplyr::select(survey_id, scientific_name, number_of_fish, trap_type, Bycatch) %>% 
  filter(Bycatch == "Yes") %>% 
  mutate(sum = sum(number_of_fish)) %>%
  group_by(trap_type) %>%
  mutate(count = sum(number_of_fish),
         percent_bycatch = count/sum) %>%
  select(scientific_name, Bycatch, trap_type, sum, count, percent_bycatch) %>% distinct()
```


## Creating a variable correlation plot

CPUE 
Length 
Reported value (KES)
Reported yield (kg)
Protein
Nutrient components
Richness



## correlation plot 

```{r}
# correlation <- data %>% 
#   select(survey_id, catch_per_trap, kg_per_trap, total_traps_collected, total_biomass_kg, 
#          total_value_KES, total_catch, value_per_trap, scientific_name) %>%
#   group_by(survey_id) %>%
#         mutate(., richness = n_distinct(scientific_name), 
#                richness_trap = richness/total_traps_collected) %>% 
#   select(-scientific_name) %>% distinct() %>% ungroup() %>%
#   na.omit() %>% select(-survey_id)
# 
# library(corrplot)
# png(height = 1400, width = 1400, file="output/response-correlation-matrix.png")
# corrplot(cor(correlation), addCoef.col = 1,    # Change font size of correlation coefficients
#          number.cex = 1.3, cl.cex = 2.5, tl.col="black", tl.cex = 2)
# dev.off()
```



