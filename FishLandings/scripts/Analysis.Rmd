---
title: "Analysis of Fishing Landings dataset"
author: "Author: Emma Strand; emma_strand@uri.edu"
output:
  github_document: default
  pdf_document:
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Prior Scripts 

QC: https://github.com/emmastrand/Kenya_SamakiSalama/blob/main/FishLandings/scripts/QC.md 

## <a name="data"></a> **Reading in datafiles**

```{r, message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(readxl)
library(lubridate)
library(Hmisc)
library(writexl)
library(naniar)
library(Rmisc)
library(stats)
library(lme4)
library(car)
library(forcats)
library(ggstatsplot)
```

## Read in the data frame that is the output of the QC script. 

Summary information so far: 741 total surveys, 591 unmodified traps, 150 modified traps. 

```{r, message=FALSE, warning=FALSE}
# read in excel file
## 4,508 rows x 25 variables (this should match the final version of QC script)
data <- read_excel("data/cleaned-Fishlandings-data-FEB 2023 JMCC.xlsx") #read in excel file 

# creating new columns with month year and date
## survey ID is master identifier that is based on `date_collected_dd_mm_yyyy` column 
data <- data %>% 
  separate(date_collected_dd_mm_yyyy, c("year", "month", "day"), remove = FALSE) 

#changing this column to numeric instead of a character (needed for next fxn)
data$month <- as.numeric(data$month) 
#changing numeric months to month names
data$month <- month.abb[data$month] 
# changing levels of month (important for figures later on); only first three letter of month 
data$month <- factor(data$month, levels=c("Jan", "Feb","Mar","Apr","May","Jun",
                                          "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
```

## Metadata summary information

**Modified traps Uyombo, Mayungu (BMUs)**
- 150 surveys
- 2021: September, August, November   
- 2022: February, March, April   
- Data collected by: CLAPERTON KAZUNGU, CELESTINE N. ALI, KADZO BAYA  
- Four landing sites: UYOMBO, MAYUNGU, MAWE YA KATI, KIVULINI
- 49 fishers involved / 69 fishers total 
- Destinations: Fish dealer, Home, Mama Karanga

**Unmodified traps in Uyombo, Mayungu (BMUs)**   
- 591 surveys 
- 2021: May, June, July, August, September, October, November, December   
- 2022: February, March, April   
- Data collected by: CLAPERTON KAZUNGU, CELESTINE N. ALI, KADZO BAYA  
- Four landing sites: UYOMBO, MAYUNGU, MAWE YA KATI, KIVULINI
- 64 fishers involved / 69 fishers total 
- Destinations: Fish dealer, Home, Mama Karanga, Gift, Other

```{r}
## modified: 546 rows from 150 unique surveys 
## unmodified: 3,962 rows from 591 surveys 

unmodified_metadata <- data %>% subset(trap_type == "UNMODIFIED") %>%
  unite(yearmonth, year, month, sep = " ", remove = FALSE)

modified_metadata <- data %>% subset(trap_type == "MODIFIED") %>%
  unite(yearmonth, year, month, sep = " ", remove = FALSE)

unique(modified_metadata$destination)
unique(unmodified_metadata$survey_id)
```


## Check ranges and add filters 

79 unique species total: 31 of those found in modified traps and 78 of those found in unmodified traps 

```{r}
range(data$total_traps_collected) ## 1-16 traps used 
range(data$total_biomass_kg) ## 0.3 kg - 24 kg 
range(data$total_value_KES) ## 60 KES - 4800 KES 
range(data$`No. of fishers in crew`) ## 1 - 6 fishermen involved with 1 representative survey per catch 
range(data$number_of_fish) ## 1 - 19 fish caught per species caught 

unique(data$length_corrected)
#unique(data$scientific_name)
#unique(unmodified_metadata$scientific_name)
```

### Editing modified and unmodified to experimental and control traps 

```{r}
data <- data %>%
  mutate(trap_type = case_when(
    trap_type == "MODIFIED" ~ "Experimental",
    trap_type == "UNMODIFIED" ~ "Control"))
```

### Additional filtering of non-realistic data 

1. Survey id `2022-02-11 12:37:00 SS/MAY/SB/035/FF` appears to set trap and collect at the same time in 2 locations so removing the location with the non-realistic CPUE of above 40. 

```{r}
## PRE FILTER 4,508 rows
## POST FILTER 4,498 rows (confirmed only the below was taken outs)
data <- data %>% 
  subset(!landing_site == "MAYUNGU" | !survey_id == "2022-02-11 12:37:00 SS/MAY/SB/035/FF")
```

## Calculating total catch per trap (CPUE)

```{r}
data2 <- data %>%
  # group by survey id
  dplyr::group_by(survey_id, trap_type) %>% 
  # count the number of fish caught for each survey id
  mutate(total_catch = sum(number_of_fish),
  # catch per unit effort (# of traps)
         CPUE = total_catch/total_traps_collected)

range(data2$total_catch) ## 1 - 114 fish 
range(data2$CPUE) ## 0.25 - 16.00 fish per trap 

CPUE_plot <- data2 %>% dplyr::select(survey_id, trap_type, CPUE) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=CPUE)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/CPUE.png", CPUE_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

Default of t.test in R is a Welch t-test which is just an adaptation of t-test, and it is used when the two samples have possibly unequal variances. Use var.equal = TRUE or FALSE to specifiy the variances of the dataset. 

You can test equal variances with a Fisher's F-test. If p < 0.05 then we include var.equal = FALSE in below ttest. If p > 0.05 then we include var.equal = TRUE in below ttest.

```{r}
data2_CPUE <- data2 %>% dplyr::select(survey_id, trap_type, CPUE) %>% distinct()

exp_CPUE <- data2_CPUE %>% subset(trap_type == "Experimental") ## 150 data points
con_CPUE <- data2_CPUE %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_CPUE$CPUE, con_CPUE$CPUE) 
## p-value = 0.0196; ratio = 0.7288769
t.test(CPUE~trap_type, data = data2_CPUE, var.equal = FALSE)
## p-value = 0.5434 

CPUE_per_trap_stats <- summarySE(data2_CPUE, measurevar = c("CPUE"), groupvars = c("trap_type"))

# CPUE_plot2 <- data2_CPUE %>% 
#   ggplot(., aes(x=trap_type, y=CPUE)) + 
#   geom_jitter(size=1, alpha=0.5, width=0.2) + theme_classic() + #ylim(2.5,3.5) +
#   geom_point(data=CPUE_per_trap_stats, aes(x=trap_type, y=CPUE), size=4) +
#   geom_errorbar(data=CPUE_per_trap_stats, aes(ymin=CPUE-se, ymax=CPUE+se), size=0.5, width=.2)
# 
# ggsave(file="output/CPUE2.png", CPUE_plot2, width = 3, height = 3.5, units = c("in"))
```

## Calculating (reported) yield per trap 

```{r}
data2 <- data2 %>%
  ## this df is still grouped by survey id and trap type 
  # reported yield (kg) per unit effort (# of traps)
  mutate(yield_kg_trap = total_biomass_kg/total_traps_collected)

range(data2$yield_kg_trap) ## 0.057 kg - 5.25 kg 

yield_kg_plot <- data2 %>% dplyr::select(survey_id, trap_type, yield_kg_trap) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=yield_kg_trap)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Yield.png", yield_kg_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data2_yieldkg <- data2 %>% dplyr::select(survey_id, trap_type, yield_kg_trap) %>% distinct()

exp_yieldkg <- data2_yieldkg %>% subset(trap_type == "Experimental") ## 150 data points
con_yieldkg <- data2_yieldkg %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_yieldkg$yield_kg_trap, con_yieldkg$yield_kg_trap) 
## p-value = 0.9069; ratio = 0.981616
t.test(yield_kg_trap~trap_type, data = data2_yieldkg, var.equal = TRUE)
## p-value = 0.0433 

yieldkg_per_trap_stats <- summarySE(data2_yieldkg, measurevar = c("yield_kg_trap"), groupvars = c("trap_type"))
```


## Calculating (reported) value per trap 

```{r}
data2 <- data2 %>%
  ## this df is still grouped by survey id and trap type 
  # reported value (KES) per unit effort (# of traps)
  mutate(value_KES_trap = total_value_KES/total_traps_collected)

range(data2$value_KES_trap) ## 11.42 KES - 1150 KES 

value_KES_plot <- data2 %>% dplyr::select(survey_id, trap_type, value_KES_trap) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=value_KES_trap)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.2, size=0.6, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Value.png", value_KES_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data2_valueKES <- data2 %>% dplyr::select(survey_id, trap_type, value_KES_trap) %>% distinct()

exp_valueKES <- data2_valueKES %>% subset(trap_type == "Experimental") ## 150 data points
con_valueKES <- data2_valueKES %>% subset(trap_type == "Control") ## 591 data points 

var.test(exp_valueKES$value_KES_trap, con_valueKES$value_KES_trap) 
## p-value = 0.8557; ratio = 0.9733375
t.test(value_KES_trap~trap_type, data = data2_valueKES, var.equal = TRUE)
## p-value = 0.03236 

valueKES_per_trap_stats <- summarySE(data2_valueKES, measurevar = c("value_KES_trap"), groupvars = c("trap_type"))
```

## Calculating median length 

```{r}
data2 <- data2 %>% ungroup() %>%
  mutate(median_length = case_when(
    length_corrected == "0-10" ~ 5,
    length_corrected == "11-15" ~ 13,
    length_corrected == "16-20" ~ 18,
    length_corrected == "21-25" ~ 23,
    length_corrected == "26-30" ~ 28,
    length_corrected == "31-35" ~ 33,
    length_corrected == "36-40" ~ 38,
    length_corrected == "41-45" ~ 43,
    length_corrected == "46-50" ~ 48,
    length_corrected == "51-60" ~ 55.5,
    length_corrected == "61-70" ~ 65.5,
    length_corrected == "71-80" ~ 75.5,
    length_corrected == "81-90" ~ 85.5,
    length_corrected == ">90" ~ 100 ### circle back to what value to use here
  )) 

hist(data2$median_length) ## majority fall within 10-40 cm 

length_plot <- data2 %>% 
  dplyr::select(survey_id, trap_type, median_length) %>% distinct() %>%
  ggplot(., aes(x=trap_type, y=median_length)) + geom_boxplot(outlier.shape = NA) + 
  geom_jitter(alpha=0.1, size=0.4, width=0.25, color="gray50") + theme_bw()

ggsave(file="output/Length.png", length_plot, width = 3, height = 3.5, units = c("in"))
```

### Statistics on the above. 

```{r}
data2_length <- data2 %>% dplyr::select(survey_id, trap_type, median_length) %>% distinct() %>%
  filter(!is.na(median_length))

exp_length <- data2_length %>% subset(trap_type == "Experimental") ## 406 data points (multiple fish per survey)
con_length <- data2_length %>% subset(trap_type == "Control") ## 2,032 data points (multiple fish per survey)

var.test(exp_length$median_length, con_length$median_length) 
## p-value < 2.2e-16; ratio = 0.6141567
t.test(median_length~trap_type, data = data2_length, var.equal = FALSE)
## p-value < 2.2e-16

length_stats <- summarySE(data2_length, measurevar = c("median_length"), groupvars = c("trap_type"))
```


## Calculating species data

73 total species of fish caught (`species_list` is output). 

Produces species counts for each type of trap. Top 5:

**Control** for 591 surveys
1: Siganus sutor (6,963)  
2: Leptoscarus vaigiensis (1,887)  
3: Lethrinus nebulosus (1,074)  
4: Scarus ghobban (1,042) 
5: Scarus rubroviolaceus (765) 

**Experimental** for 150 surveys 
1: Siganus sutor (1,818)
2: Scarus ghobban (124) 
3: Lethrinus nebulosus (113) 
4: Siganus canaliculatus (84)
5: Parupeneus macronemus (50) 

```{r}
spp_df <- data2 %>% ungroup() %>%
  group_by(scientific_name, trap_type) %>%
  ## this df is still grouped by survey id and trap type 
  # reported value (KES) per unit effort (# of traps)
  mutate(spp_count = sum(number_of_fish)) %>% 
  dplyr::select(scientific_name, trap_type, spp_count) %>% distinct() %>% ungroup()

species_list <- spp_df %>% dplyr::select(scientific_name) %>% distinct()
species_list %>% write.csv("data/full_species_list.csv")
```


## Loading Galligan and FishBase dataset 

Most species in the list above have metadata below. 

```{r}
fishbase_lifehistory <- read_excel("data/fishbase.xlsx", sheet = "life history") %>% #read in excel file 
  select(scientific_name, Lm, Lmax) %>% dplyr::rename(Lm_fishbase = Lm) %>% dplyr::rename(Lmax_fishbase = Lmax) 

# rows that appear in species_list but not fishbase_lifehistory
## checking which fish I still need Fishbase information for (44 species)
# dplyr::setdiff(species_list, fishbase_lifehistory) %>% write.csv("data/add_fishbase_info.csv")

fishbase_biomass <- read_excel("data/fishbase.xlsx", sheet = "biomass") %>%
  dplyr::select(scientific_name, a, b)

galligan <- read.csv("data/SpeciesData_GatedTraps_Galligan_edited.csv", header=TRUE, sep = ",") %>%
  dplyr::rename(scientific_name = Species) %>% dplyr::select(., scientific_name)
# dplyr::setdiff(species_list, galligan) 
### 11 fish found in our dataset that are not found in Galligan dataset 
## these won't be included in the nutrient or revenue analysis
## I think this is OK b/c all species have 113 or lower than 40 total catch
```



#### OLD SCRIPT; reworking above 

### Plotting figures.


The relationship between grams per trap and total catch per trap. 

```{r}
modified_trap_df %>% #filter(catch_per_trap < 10) %>%
  ggplot(aes(x=catch_per_trap, y=kg_per_trap, color=trap_type)) +
  scale_color_manual(values = c( "#387780", "#FF8C61")) +
  scale_fill_manual(values = c( "#387780", "#FF8C61")) +
  theme_bw() + xlab("CPUE (n trap-1)") + ylab("Yield (kg trap-1)") +
  geom_smooth(aes(fill=trap_type), method="loess", se=TRUE, fullrange=TRUE, level=0.95, color="black") +
  geom_point(aes(fill=trap_type), pch = 21, size=1)

library(ggExtra)
p <- data %>%
  select(survey_id, month, BMU, trap_type, catch_per_trap, scientific_name) %>% distinct() %>%
  group_by(survey_id) %>%
  mutate(richness = n_distinct(scientific_name)) %>%
  ggplot(., aes(x=richness, y=catch_per_trap, color=trap_type)) +
      geom_point() + theme_bw() + 
      scale_color_manual(values = c( "#387780", "#FF8C61")) +
      theme(legend.position="none") 
ggMarginal(p, type="boxplot")

data %>%
  select(survey_id, month, BMU, trap_type, catch_per_trap, 
         scientific_name, total_traps_collected) %>% distinct() %>%
  group_by(survey_id) %>%
  mutate(richness = n_distinct(scientific_name),
         richness_trap = richness/total_traps_collected) %>%
  #filter(catch_per_trap < 10) %>%
  ggplot(aes(x=trap_type, y=richness, color=trap_type)) +
  scale_color_manual(values = c( "#387780", "#FF8C61")) +
  scale_fill_manual(values = c( "#387780", "#FF8C61")) +
  theme_bw() + xlab("") + ylab("Richness (# of unique species per fishing trip)") +
  geom_boxplot() + geom_jitter(size=0.5, alpha=0.1, width=0.2) 
  #geom_point(aes(fill=trap_type), pch = 21, size=1, alpha=0.2) 
  #geom_smooth(aes(fill=trap_type), method="loess", se=TRUE, fullrange=TRUE, level=0.95, color="black")

data %>%
  select(survey_id, month, BMU, trap_type, catch_per_trap, 
         scientific_name, total_traps_collected) %>% distinct() %>%
  group_by(survey_id) %>%
  mutate(richness = n_distinct(scientific_name)) %>%
  ggplot(., aes(x = richness, fill = trap_type)) +                       # Draw overlaying histogram
    geom_histogram(position = "identity", alpha = 0.4, bins = 10) + theme_bw() +
  scale_fill_manual(values = c( "#387780", "#FF8C61")) 

### Species richness plot 

species_rich_plot <- data %>%
  select(survey_id, month, BMU, trap_type, catch_per_trap, 
         scientific_name, total_traps_collected) %>% distinct() %>%
  group_by(survey_id) %>%
  mutate(richness = n_distinct(scientific_name),
         richness_trap = richness/total_traps_collected) %>% 
  select(-scientific_name) %>%
  ungroup() %>% distinct() %>%
  ggbetweenstats(., x = trap_type, y = richness, 
               type = "np", plot.type = "box", sample.size.label = TRUE,
               mean.point.args = list(size = 2, color = "gray"),
               mean.label.args = list(size = 2),
               point.args = list(position = ggplot2::position_jitterdodge(dodge.width = 0.1), 
                                 alpha= 0.1, size = 1, stroke = 0)) +
  scale_color_manual(values = c( "black", "black")) +
  labs(x = "Trap Type", y = "Richness (# of unique species per fishing trip)") 

ggsave(file="output/Species_richness.png", species_rich_plot, width = 4.5, height = 5, units = c("in"))

spprich <- data %>%
  select(survey_id, month, BMU, trap_type, catch_per_trap, 
         scientific_name, total_traps_collected) %>% distinct() %>%
  group_by(survey_id) %>%
  mutate(richness = n_distinct(scientific_name),
         richness_trap = richness/total_traps_collected) %>% 
  select(-scientific_name) %>%
  ungroup() %>% distinct() 

spprich_means <- summarySE(data=spprich, measurevar = c("richness"), 
                               groupvars = c("trap_type"), na.rm = TRUE)

t.test(richness~trap_type, data = spprich, var.equal = FALSE)
```

## correlation plot 

```{r}
correlation <- data %>% 
  select(survey_id, catch_per_trap, kg_per_trap, total_traps_collected, total_biomass_kg, 
         total_value_KES, total_catch, value_per_trap, scientific_name) %>%
  group_by(survey_id) %>%
        mutate(., richness = n_distinct(scientific_name), 
               richness_trap = richness/total_traps_collected) %>% 
  select(-scientific_name) %>% distinct() %>% ungroup() %>%
  na.omit() %>% select(-survey_id)

library(corrplot)
png(height = 1400, width = 1400, file="output/response-correlation-matrix.png")
corrplot(cor(correlation), addCoef.col = 1,    # Change font size of correlation coefficients
         number.cex = 1.3, cl.cex = 2.5, tl.col="black", tl.cex = 2)
dev.off()
```



## <a name="species"></a> **Calculate top species caught**

**Species catch per unit effort between modified and traditional traps. Take the top 3-5 species and run #1 for them separately.**

Calculating which species were the most abundant across the entire survey.  

This might have to be number of fish caught per trap? So that the difference in # of traps for modified and unmodified is accounted for?

This is split for modified and unmodified so far.. but can be changed to combined.. the trend is about the same for most abundant type of fish in each trap.. 

```{r}
# above 250 cut off includes top each count for each type of trap 
species_list %>% filter(species_catch > 250) %>%
  ggplot(., aes(x=scientific_name, y=species_catch, group = trap_type, color = trap_type)) + 
  ylab("number of fish caught") + xlab("Genus species") +
  ggtitle("Species with counts > 250") +
  scale_color_manual(values = c( "#387780", "#FF8C61")) +
  geom_point() + theme_bw() + theme(axis.text.x = element_text(angle = 60, hjust=1)) #Set the text angle
```

## <a name="species_pertrap"></a> **Top species stats per trap**

Create a subsetted df from the top 10 total species (break this down into modified and unmodified later?).

```{r}
# calculate species total catch to then figure out which ones were most popular regardless of trap type
species_df <- data %>% filter(!is.na(number_of_fish)) %>%
  group_by(scientific_name) %>%
  mutate(species_total_catch = sum(number_of_fish)) %>% ungroup() #must ungroup for following commands 

# use the above metric to subset to top X of those 
species_keep <- species_df %>% select(scientific_name, species_total_catch) %>% 
  distinct() %>% slice_max(species_total_catch, n = 20) 

# filter species df based on the species_keep list 
species_df <- species_df %>% filter(scientific_name %in% species_keep$scientific_name)

# double checking the above command worked - output should be the n = value above  
unique(sort(species_keep$scientific_name))
```

### Abundance  

```{r}
### species_df is already subsetted to the top 10 species 
# within each survey id, for each species calculate topspecies_catch as the number fish in that species in that survey
# then calculate the catch per trap as the number of fish of that species over the total number of traps collected
species_df <- species_df %>%
  dplyr::group_by(survey_id, scientific_name) %>% # group by survey id
  mutate(topspecies_catch = sum(number_of_fish),
         catch_per_trap = topspecies_catch/total_traps_collected) %>% #divide total catch per survey id by total traps 
  dplyr::ungroup(survey_id, scientific_name) #ungroup by this column

species_df %>%
  ggplot(aes(x=trap_type, y=catch_per_trap, color=trap_type)) + 
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
  geom_point() +
  facet_wrap(~scientific_name, scales = "free_y") +
  theme_classic() + ggtitle("Top 10 most abundant species") +
  ylab("CPUE (n trap-1)") + xlab("Genus species") +
  theme(axis.text.x = element_text()) #Set the text angle
```





### Statistics for the top ten species

Left off at trying to solve the following error when running aov: 

Error in as.POSIXlt.character(x, tz, ...) : character string is not in a standard unambiguous format

Error in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) : NA/NaN/Inf in 'y'

```{r}
Topspp_MOD <- species_df %>% subset(trap_type == "Experimental")

Topspp_UNMOD <- species_df %>% subset(trap_type == "Control")  

var.test(Topspp_MOD$catch_per_trap, MOD$catch_per_trap) # output is significant so put false below

#t.test(catch_per_trap~trap_type, data = species_df, var.equal = FALSE)

#aov(catch_per_trap ~ trap_type + scientific_name, data = species_df)
```


## <a name="maturity"></a> **Catch per unit effort for top species by maturity**

**Total mature fish catch per unit effort between modified and traditional traps. This will have to be for the top 3-5 species separately. Go to Fishbase and find the length at first maturity for that particular species, then assign each fish a "mature" or "immature" status in the data and calculate.**

Data pulled from Fishbase and put in the datasheet `fishbase.xlsx`. 

```{r}


maturity <- full_join(data, fishbase, by = "scientific_name") %>% # joining maturity reproduction info with main dataframe
  filter(!is.na(Lm)) # taking out observations that don't have an Lm value so only the top species 

maturity <- maturity %>% 
  mutate(maturity = if_else(median_length >= Lm, "mature", "immature")) %>%
  subset(trap_type == "Experimental" | trap_type == "Control") %>% #subsetting to only the modified and unmodified traps 
  select(survey_id, year, scientific_name, trap_type, maturity, total_traps_collected, 
         length_corrected, median_length, number_of_fish, Lm) %>%
  mutate(nofish_pertrap = number_of_fish/total_traps_collected) 
```

Immaure and mature fish catch comparison

```{r}
maturity %>% select(number_of_fish, trap_type, maturity, scientific_name, 
                    total_traps_collected, nofish_pertrap) %>% 
  na.omit() %>% 
  ggplot(., aes(x=scientific_name, y=nofish_pertrap, color=maturity)) +
  geom_boxplot() + theme_classic() + 
  theme(axis.text.x = element_text(angle=60, hjust=1)) +
  xlab("Species") +
  ylab("Abundance (number of individuals per trap collected)")

maturity %>% select(number_of_fish, trap_type, maturity, scientific_name, total_traps_collected, nofish_pertrap) %>% 
  na.omit() %>%  
  ggplot(., aes(x=maturity, y=nofish_pertrap, color=trap_type)) +
  geom_boxplot() + theme_classic() + 
  facet_wrap(~trap_type, scales = "free_y") +
  #theme(axis.text.x = element_text(angle=60, hjust=1)) +
  xlab("Maturity") +
  ylab("Abundance (number of individuals per trap collected)")
```

Statistics on the above... 

Circle back to the padj values coming out to "0.000000e+00". 

Double check `trap_type+maturity` vs `trap_type*maturity`.  

```{r}
nofish_maturity_aov <- aov(number_of_fish ~ trap_type*maturity, data = maturity)
summary(nofish_maturity_aov)

nofish_maturity_tukey <- TukeyHSD(nofish_maturity_aov)
nofish_maturity_tukey$`trap_type:maturity`
```

## <a name="length"></a> **Catch and length data of mature fish**

**Average length of catch versus length at first maturity (Lmat). Take the difference for each fish in the data against its length at first maturity and then calculate a weighted value for modified versus traditional traps where a value above 0 represents a fish above Lmat and a value below represents a fish below Lmat.**

Transform count value to that number of observations: https://stackoverflow.com/questions/70759069/transform-count-column-into-number-of-rows. 

```{r}
maturity_dist <- maturity %>% 
  mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
  tidyr::uncount(., number_of_fish, .remove = TRUE) %>% # expanding number of fish to number of observations
  mutate(length_dist = median_length-Lm) %>%
  filter(!is.na(length_dist)) %>%
  group_by(scientific_name, trap_type) %>%
  mutate(avg_length_dist = mean(length_dist)) %>% #### a positive value here = mature; a negative value = immature 
  ungroup() %>% 
  filter(scientific_name %in% species_keep$scientific_name) %>%
  mutate(scientific_name = factor(scientific_name, levels = c("Siganus sutor", "Lethrinus nebulosus",
                                                              "Scarus ghobban", "Siganus canaliculatus",
                                                              "Leptoscarus vaigiensis", "Parupeneus indicus",
                                                              "Acanthurus dussumieri", "Chaetodon selene",
                                                              "Parupeneus macronemus", "Scarus rubroviolaceus",
                                                              "Scarus russelii", "Scarus psittacus",
                                                              "Naso annulatus", "Plectorhinchus vittatus",
                                                              "Plectorhinchus sordidus", "Plectorhinchus gaterinus",
                                                              "Lethrinus harak", "Siganus stellatus",
                                                              "Chaetodon auriga", "Lethrinus mahsena"))) 
maturity_dist$scientific_name <- fct_rev(maturity_dist$scientific_name)

maturity_dist_plot <- maturity_dist %>%
  filter(!is.na(scientific_name)) %>%
  group_by(scientific_name) %>%
  filter(., n_distinct(avg_length_dist) >= 2) %>% # filters out the observations aren't in both categories (takes out species that only have 1 unique mean dist value so only 1 trap type)
  ungroup() %>%
  ggplot(., aes(x=scientific_name, y=avg_length_dist, fill=trap_type)) + 
  coord_flip() +
  scale_fill_manual(values = c("black", "white")) +
  geom_hline(yintercept = 0, lty = "dotted") +
  theme(axis.text.y = element_text(face = "italic")) +
  geom_line(aes(group = scientific_name), color="grey14") +
  geom_point(size=2, shape=21) + theme_bw() + 
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  labs(y="Distance from Lmat (cm)", x="", fill="Trap Type") 

ggsave(file="output/Maturity.png", maturity_dist_plot, width = 7, height = 6, units = c("in"))
```



## <a name="freq_plots"></a> **Length Frequency plots of top species**

**Length frequency of top 3-5 species in modified versus traditional (different colors) with Lmat etc. indicators pulled from Fishbase.**

http://derekogle.com/fishR/2017-07-28-JoyPlot

From the `species_keep` df:

Siganus sutor	= 311813  	 		 
Lethrinus nebulosus	= 51612	     		
Scarus ghobban	= 34253  			  
Siganus canaliculatus	= 23173  		  	
Leptoscarus vaigiensis	= 15758	  

```{r}
library(ggridges)

# the column we want to plot: maturity$length_corrected
maturity$length_corrected <- factor(maturity$length_corrected, levels=c("0-10", "11-15","16-20","21-25","26-30",
                                                                        "31-35","36-40","41-45", "46-50", "51-60",
                                                                        "61-70", "71-80", "81-90", ">90"))

maturity <- maturity %>% filter(!is.na(length_corrected)) %>%
  group_by(length_corrected, scientific_name, trap_type) %>%
  mutate(count.per.bin = sum(number_of_fish)) %>%
  ungroup()

maturity_topspp <- maturity %>% #subset(year=="2022") %>% 
  subset(scientific_name == "Siganus sutor" | scientific_name == "Lethrinus nebulosus" |
           scientific_name == "Scarus ghobban" | scientific_name == "Leptoscarus vaigiensis" |
           scientific_name == "Siganus canaliculatus") %>%
    mutate(Lm_range = case_when(
    Lm >= 0 & Lm <= 10.5 ~ "0-10",
    Lm >= 10.5 & Lm <= 15.4 ~ "11-15",
    Lm >= 15.5 & Lm <= 20.4 ~ "16-20",
    Lm >= 20.5 & Lm <= 25.4 ~ "21-25",
    Lm >= 25.5 & Lm <= 30.4 ~ "26-30",
    Lm >= 30.5 & Lm <= 35.4 ~ "31-35",
    Lm >= 35.5 & Lm <= 40.4 ~ "36-40",
    Lm >= 40.5 & Lm <= 45.4 ~ "41-45",
    Lm >= 45.5 & Lm <= 50.4 ~ "46-50",
    Lm >= 50.5 & Lm <= 60.4 ~ "51-60",
    Lm >= 60.5 & Lm <= 70.4 ~ "61-70",
    Lm >= 70.5 & Lm <= 80.4 ~ "71-80",
    Lm >= 80.5 & Lm <= 90.4 ~ "81-90",
    Lm > 90.5 ~ ">90")) 

# creating table that will work best for visualization 
maturity_figs <- maturity_topspp %>% 
  mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
  tidyr::uncount(., number_of_fish, .remove = TRUE)

maturity_figs$scientific_name = factor(maturity_figs$scientific_name, levels=c('Siganus sutor',
                                                                               'Lethrinus nebulosus',
                                                                               'Scarus ghobban',
                                                                               'Siganus canaliculatus',
                                                                               'Leptoscarus vaigiensis'))

# setting common figure parameters 
a <- maturity_figs %>% # expanding number of fish to number of observations
  filter(!is.na(length_corrected)) %>%
  ggplot(., aes(x=length_corrected, fill=trap_type, color=trap_type)) + 
  theme_bw() + xlab("Length (cm)") + ylab("Frequency") +
  theme(axis.text.x.bottom = element_text(colour = 'black', angle = 60, hjust = 1),
        axis.text.y = element_text(colour = 'black', size = 8, face = 'italic')) + 
  theme(panel.border = element_blank(),
   panel.grid.major = element_blank(),
   panel.grid.minor = element_blank(),
   strip.text.x = element_text(size = 9, color = "black", face = "bold.italic"),
   axis.line = element_line(colour = "black")) +
  theme(axis.title.y = element_text(size = 12, face = "bold", margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(size = 12, face = "bold", margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  facet_grid(scientific_name~trap_type, scales = "free_y")
  #ggtitle("Not standardized by per trap - come back to this?")
```


### Calculating % fish underneath Lm and sample size per trap type for the figure below 

```{r}
maturity_calcs <- maturity_figs %>%
  group_by(scientific_name, trap_type) %>%
  mutate(sample_size = n(),
         count_below = sum(median_length <= Lm, na.rm=TRUE),
         percent_below = (count_below/sample_size)*100) %>%
 select(scientific_name, trap_type, sample_size, 
         count_below, percent_below) %>% 
  ungroup() %>% distinct()

# double checking the above calculation worked
maturity_figs %>% 
  filter(scientific_name == "Siganus sutor", trap_type == "Control") %>%
  count(maturity == "immature") 
```


```{r}
length_freq <- a +
  geom_bar(position = position_dodge(), alpha=0.5) +
  scale_fill_manual(values = c("gray60", "white")) +
  scale_color_manual(values = c("black", "black"))

ggsave(file="output/Length_freq.png", length_freq, width = 6, height = 8, units = c("in"))

### left off at trying to get a density or geom smooth on categorical data - haven't been able to make that work
a + geom_histogram(aes(y = ..count.., colour = trap_type, fill = trap_type), 
                   alpha = 0.6, position = position_dodge(), stat="count") +
  geom_vline(data = maturity_figs, mapping = aes(xintercept = Lm_range), lty = "dotted", size=1.2)
```

https://rstudio-pubs-static.s3.amazonaws.com/595950_6dc36259819541e5869f9fff162a8a41.html#histogram

https://statisticsglobe.com/normal-density-curve-on-top-of-histogram-ggplot2-r

### Biomass per trap collected

1.) Expand df by # of fish so that each row is a fish observation.    
2.) Calculate median length of the bin of each fish (L).   
3.) Find a and b parameters for all fish. Add this to the fishbase and read in that df.  
4.) Add a and b columns to `species_df` by species Id.  
5.) Mutate to calculate W=aLb.  
6.) Group by species and survey id to calculate biomass per trap collected.   

#### Calculating biomass

W=aL^b 

W = Biomass  
L = Length (in our case, median length)  
a = (taken from fishbase)
b = (taken from fishbase)

Read in data from fishbase. These units are in cm and grams. 

https://www.fishbase.de/manual/English/FishbaseThe_LENGTH_WEIGHT_table.htm


```{r}
biomass_fishbase <- read_excel("data/fishbase.xlsx", sheet = "biomass") %>% #read in excel file 
  select(scientific_name, a, b)
biomass_fishbase$a <- as.numeric(biomass_fishbase$a)
biomass_fishbase$b <- as.numeric(biomass_fishbase$b)

biomass_survey_data <- data %>% filter(!is.na(number_of_fish)) %>%
  subset(trap_type == "Experimental" | trap_type == "Control") %>%
  select(survey_id, Operation_date, year, month, day, enumerator, trap_type, total_traps_collected,
         total_biomass_kg, take_home_weight_kg, total_value_KES, take_home_value_KES, scientific_name, 
         length_cm, number_of_fish, crew_size_corrected, length_corrected, percent_composition) 

biomass_df <- full_join(biomass_survey_data, biomass_fishbase, by = "scientific_name") 

biomass_df <- biomass_df %>%
 # mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
 # tidyr::uncount(., number_of_fish, .remove = TRUE) %>%
  mutate(median_length = case_when(
    length_corrected == "0-10" ~ 5,
    length_corrected == "11-15" ~ 13,
    length_corrected == "16-20" ~ 18,
    length_corrected == "21-25" ~ 23,
    length_corrected == "26-30" ~ 28,
    length_corrected == "31-35" ~ 33,
    length_corrected == "36-40" ~ 38,
    length_corrected == "41-45" ~ 43,
    length_corrected == "46-50" ~ 48,
    length_corrected == "51-60" ~ 55.5,
    length_corrected == "61-70" ~ 65.5,
    length_corrected == "71-80" ~ 75.5,
    length_corrected == "81-90" ~ 85.5,
    length_corrected == ">90" ~ 100 ### circle back to what value to use here
  )) %>%
  mutate(W_g = (a*(median_length^b))*number_of_fish,
         W_kg = W_g/1000, # calculating biomass from W=aL^b 
         biomasscomp = total_biomass_kg*percent_composition) %>% 
  group_by(survey_id) %>%
  filter(!is.na(W_kg)) %>%
  mutate(calculated_total_biomass = sum(W_kg),
         calculated_biomass_pertrap = calculated_total_biomass/total_traps_collected) %>% 
  ungroup()

biomass_comparison <- biomass_df %>% select(survey_id, total_biomass_kg, calculated_total_biomass) %>%
  distinct() %>% na.omit() %>%
  mutate(comparison = if_else(total_biomass_kg > calculated_total_biomass, "REPORTED > CALC", "REPORTED < CALC"),
         difference = total_biomass_kg-calculated_total_biomass) 

biomass_comparison %>%
  ggplot(., aes(x=comparison, y=difference)) + theme_bw() +
  geom_point(aes(color=comparison), size=1) + xlab("") + ylab("difference in value")
```

Calculated biomass per trap figures. 

```{r}
# basic grams per trap plot with no other variables 
biomass_df %>% filter(!is.na(calculated_biomass_pertrap)) %>%
  ggplot(aes(x=trap_type, y=calculated_biomass_pertrap, color=trap_type)) + 
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Calculated Biomass (kg per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle

# visually seeing if this differs by fisherman 
biomass_df %>% filter(!is.na(calculated_biomass_pertrap)) %>%
  ggplot(aes(x=trap_type, y=calculated_biomass_pertrap, color=trap_type)) + 
  facet_wrap(~enumerator) +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Calculated Biomass (kg per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle
```


List of species to ask Fishbase for a and b. 

```{r}
# biomass_df %>% 
#   select(scientific_name) %>% distinct() %>%
#   write.csv("data/full_species_list.csv")
```

## Economic Data

Profit data from Gilligan's sheet. 

```{r}


## species df for profit analysis 
species_df_forprofit <- species_df %>% select(survey_id, month, scientific_name, trap_type) %>% distinct()

## adding gilligan to the species df above
## need to also add the calculated biomass  values 
## run the biomass_df chunk at the bottom of this script 
biomass_df_forprofit <- biomass_df %>% 
  dplyr::select(survey_id, scientific_name, trap_type, total_traps_collected, biomasscomp, W_kg, length_corrected) %>% 
  filter(!is.na(W_kg)) %>%
  group_by(survey_id) %>% mutate(yield_calc_kg = sum(W_kg), 
                                 yield_calc_kg_trap = yield_calc_kg/total_traps_collected) %>% 
  ungroup() %>% distinct()

### using biomasscomp(kg) that is composition of reported biomass 
gilligan_profit_data <- left_join(species_df_forprofit, gilligan_profit, by = "scientific_name") %>%
  left_join(., biomass_df_forprofit, by = c("scientific_name", "survey_id", "trap_type")) %>% distinct() %>%
  mutate(KSHperspp = Price_KSHPerkg*biomasscomp) %>% group_by(survey_id) %>%
  mutate(KSHpersurvey = sum(KSHperspp)) %>% ungroup() %>%
  mutate(KSHpertrap = KSHpersurvey/total_traps_collected)

gilligan_profit_data_slim <- gilligan_profit_data %>% 
  select(trap_type, month, survey_id, KSHpertrap) %>% distinct()

biomass_df_forprofit_slim <- biomass_df_forprofit %>%
  select(trap_type, survey_id, yield_calc_kg_trap) %>% distinct()

gilligan_profit_data_means <- summarySE(data=gilligan_profit_data_slim, measurevar = c("KSHpertrap"), 
                               groupvars = c("trap_type", "month"), na.rm = TRUE)

profitplot1 <- gilligan_profit_data_slim %>% 
  ggplot(., aes(x=month, y=KSHpertrap, lty=trap_type)) +  
  #scale_color_manual(values = c( "#387780", "#FF8C61")) +
  #scale_fill_manual(values = c( "#387780", "#FF8C61")) +
  theme_bw() + xlab("Month") + ylab("Revenue (KSH trap-1)") +
  geom_line(data=gilligan_profit_data_means, aes(group = trap_type), size=0.5) +
  geom_point(data = gilligan_profit_data_means, aes(x=month, y=KSHpertrap), size=1) +
  geom_errorbar(data = gilligan_profit_data_means, aes(ymin=KSHpertrap-se, ymax=KSHpertrap+se), size=0.5, width=.2)

ggsave(file="output/Profit_calculated.png", profitplot1, width = 5.5, height = 3.5, units = c("in"))

### 
KSHplot <- ggbetweenstats(data=gilligan_profit_data_slim, x = trap_type, y = KSHpertrap, 
               type = "np", plot.type = "boxviolin", sample.size.label = TRUE,
               mean.point.args = list(size = 2, color = "gray"),
               mean.label.args = list(size = 2),
               point.args = list(position = ggplot2::position_jitterdodge(dodge.width = 0.5), 
                                 alpha= 0.2, size = 1.5, stroke = 0)) +
  scale_color_manual(values = c( "#387780", "#FF8C61")) +
  labs(x = "Trap Type", y = "KSH per trap") 

Wkgplot <- ggbetweenstats(data=biomass_df_forprofit_slim, x = trap_type, y = yield_calc_kg_trap, 
               type = "np", plot.type = "boxviolin", sample.size.label = TRUE,
               mean.point.args = list(size = 2, color = "gray"),
               mean.label.args = list(size = 2),
               point.args = list(position = ggplot2::position_jitterdodge(dodge.width = 0.5), 
                                 alpha= 0.2, size = 1.5, stroke = 0)) +
  scale_color_manual(values = c( "#387780", "#FF8C61")) +
  labs(x = "Trap Type", y = "Yield (kg) per trap")

# ggsave(file="output/Value_calculated.png", KSHplot, width = 4.5, height = 5, units = c("in"))
# ggsave(file="output/Yield_calculated.png", Wkgplot, width = 4.5, height = 5, units = c("in"))

t.test(KSHpertrap~trap_type, data = gilligan_profit_data_slim, var.equal = FALSE)

KSHpertrap_trap_stats <- gilligan_profit_data_slim %>% 
  filter(!is.na(KSHpertrap)) %>% filter_at(vars(KSHpertrap), all_vars(!is.infinite(.)))

KSHpertrap_trap_stats <- summarySE(KSHpertrap_trap_stats, measurevar = c("KSHpertrap"), 
                             groupvars = c("trap_type"))
```


Profit data from Kenya team. 

```{r}
# profit <- read_excel("output/statistics_v2.xlsx", sheet = "Profit sheet for R", skip=3) %>%
#   gather("key", "rev_KES", 2:21) %>% rename(scientific_name = Species) %>%
#   mutate(key = case_when(
#     key == "<16 cm...2" ~ "MAYUNGU Kaskazi cm<16",
#     key == ">16 cm...3" ~ "MAYUNGU Kaskazi cm>16",
#     key == "<16 cm...4" ~ "MAYUNGU Kusi cm<16",
#     key == ">16 cm...5" ~ "MAYUNGU Kusi cm>16",
#     key == "<10 cm...6" ~ "UYOMBO Kaskazi cm<10",
#     key == ">16 cm...7" ~ "UYOMBO Kaskazi cm>10",
#     key == "<10 cm...8" ~ "UYOMBO Kusi cm<10",
#     key == ">10 cm...9" ~ "UYOMBO Kusi cm>10",
#     key == "<10 cm...10" ~ "KURUWITU Kaskazi cm<10",
#     key == ">10 cm...11" ~ "KURUWITU Kaskazi cm>10",
#     key == "<10 cm...12" ~ "KURUWITU Kusi cm<10",
#     key == ">10 cm...13" ~ "KURUWITU Kusi cm>10",
#     key == "<15 cm...14" ~ "TAKAUNGU Kaskazi cm<15",
#     key == ">15 cm...15" ~ "TAKAUNGU Kaskazi cm>15",
#     key == "<15 cm...16" ~ "TAKAUNGU Kusi cm<15",
#     key == ">15 cm...17" ~ "TAKAUNGU Kusi cm>15",
#     key == "<10 cm...18" ~ "KANAMI Kaskazi cm<10",
#     key == ">10 cm...19" ~ "KANAMI Kaskazi cm>10",
#     key == "<10 cm...20" ~ "KANAMI Kusi cm<10",
#     key == ">10 cm...21" ~ "KANAMI Kusi cm>10")) %>%
#   separate(key, c("BMU", "Season", "Length_category"), sep = " ")
# 
# profit_data <- species_df %>%
#   #full_join(species_df, profit, by = "scientific_name") %>%
#   mutate(Season = case_when(
#     month == "Apr" | month == "May" | month == "Jun" |
#       month == "Jul" | month == "Aug" | month == "Sep" |
#       month == "Oct" ~ "Kusi",
#     month == "Nov" | month == "Dec" | month == "Jan" |
#       month == "Feb" | month == "Mar" ~ "Kaskazi")) %>%
#   mutate(Length_category = case_when(
#     BMU == "MAYUNGU" & median_length <= 16 ~ "cm<16",
#     BMU == "MAYUNGU" & median_length > 16 ~ "cm>16",
#     BMU == "UYOMBO" & median_length <= 10 ~ "cm<10",
#     BMU == "UYOMBO" & median_length > 10 ~ "cm>10",
#     BMU == "KURUWITU" & median_length <= 10 ~ "cm<10",
#     BMU == "KURUWITU" & median_length > 10 ~ "cm>10",
#     BMU == "TAKAUNGU" & median_length <= 15 ~ "cm<15",
#     BMU == "TAKAUNGU" & median_length > 15 ~ "cm>15",
#     BMU == "KANAMI" & median_length <= 10 ~ "cm<10",
#     BMU == "KANAMI" & median_length > 10 ~ "cm>10")) %>%
#   left_join(., profit, by = c("scientific_name", "BMU", "Season", "Length_category")) %>%
#   mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
#   mutate(total_sppvalue = number_of_fish*rev_KES) %>%
#   group_by(survey_id) %>%
#   mutate(totalrev = sum(total_sppvalue),
#          rev_pertrap = totalrev/total_traps_collected,
#          rev_perman = rev_pertrap/`No. of fishers in crew`) %>% ungroup()
# 
# profit_data_slim <- profit_data %>%
#   select(survey_id, rev_pertrap, trap_type, month, Season, BMU, rev_perman) %>% distinct()
# profit_data_means <- summarySE(data=profit_data_slim, measurevar = c("rev_pertrap"),
#                                groupvars = c("trap_type", "month"), na.rm = TRUE)
# profit_data_means <- profit_data_means %>% filter(!is.na(se)) %>%
#   rename(revT_se = se)
# profit_data_means2 <- summarySE(data=profit_data_slim, measurevar = c("rev_perman"),
#                                groupvars = c("trap_type", "month"), na.rm = TRUE)
# profit_data_means2 <- profit_data_means2 %>% filter(!is.na(se)) %>%
#   rename(revTF_se = se)
# 
# profit_together <- full_join(profit_data_means2, profit_data_means, by=c("trap_type", "month"))
# 
# profitplot2 <- profit_data_slim %>%
#   ggplot(., aes(x=month, y=rev_pertrap, color=trap_type)) +
#   scale_color_manual(values = c( "#387780", "#FF8C61")) +
#   scale_fill_manual(values = c( "#387780", "#FF8C61")) +
#   theme_bw() + xlab("Month") + ylab("Revenue (KES trap-1)") +
#   #geom_boxplot()
#   geom_line(data=profit_data_means, aes(group = trap_type), size=0.5) +
#   geom_point(data = profit_data_means, aes(x=month, y=rev_pertrap), size=1) +
#   geom_errorbar(data = profit_data_means, aes(ymin=rev_pertrap-revT_se, ymax=rev_pertrap+revT_se), size=0.5, width=.2)
# 
# ggsave(file="output/Profit_reported.png", profitplot2, width = 5.5, height = 3.5, units = c("in"))
# 
# profit_data_slim %>%
#   ggplot(., aes(x=month, y=rev_perman, color=trap_type)) +
#   scale_color_manual(values = c( "#387780", "#FF8C61")) +
#   scale_fill_manual(values = c( "#387780", "#FF8C61")) +
#   theme_bw() + xlab("Month") + ylab("Revenue (KES trap-1 fisher-1)") +
#   #geom_boxplot()
#   geom_line(data=profit_data_means2, aes(group = trap_type), size=0.5) +
#   geom_point(data = profit_data_means2, aes(x=month, y=rev_perman), size=1) +
#   geom_errorbar(data = profit_data_means2, aes(ymin=rev_perman-revTF_se, ymax=rev_perman+revTF_se), size=0.5, width=.2)
# 
# ggplot(profit_together, aes(x=month, color=trap_type)) +
#   geom_line(aes(y=rev_pertrap, group = trap_type), size=1) +
#   geom_line(aes(y=rev_perman, group = trap_type), size=1, lty = "dotted") +
#   theme_bw() +
#   scale_color_manual(values = c( "#387780", "#FF8C61")) +
#   geom_point(aes(x=month, y=rev_perman), size=1) +
#   geom_errorbar(aes(ymin=rev_perman-revTF_se, ymax=rev_perman+revTF_se), size=0.75, width=.2) +
#   geom_point(aes(x=month, y=rev_pertrap), size=1) +
#   geom_errorbar(aes(ymin=rev_pertrap-revT_se, ymax=rev_pertrap+revT_se), size=0.75, width=.2)
# 
# 
# profit_stats <- summarySE(profit_data, measurevar = c("catch_per_trap"),
#                                groupvars = c("`value (KES)`", "trap_type"))
# 
# ## value (KES), catch_per_trap
# profit_data %>%
#   ggplot(aes(x=`value (KES)`, y=catch_per_trap)) +
#   theme_classic() +
#   geom_jitter(alpha=0.05, aes(color=trap_type)) +
#   geom_point(data = profit_stats, aes(x=`value (KES)`, y=catch_per_trap), size=3) +
#   geom_errorbar(data = profit_stats, aes(ymin=catch_per_trap-se, ymax=catch_per_trap+se), size=0.5, width=.1)
# 
# profit_fig <- profit_stats %>% subset(`value (KES)` == "350") %>%
#   ggplot(aes(x=`value (KES)`, y=catch_per_trap)) +
#   theme_classic() +
#   theme(legend.position = "none") +
#   geom_point(aes(color=trap_type), size=1) +
#   ylab("CPUE (n trap-1)") +
#   geom_errorbar(aes(ymin=catch_per_trap-se, ymax=catch_per_trap+se), size=.5, width=0)
# 
# ggsave(file="output/Profit-350.png", profit_fig, width = 2, height = 4, units = c("in"))
# 
# profit_fig <- profit_stats %>% ggplot(aes(x=trap_type, y=catch_per_trap)) +
#   theme_classic() +
#   facet_wrap(~`value (KES)`, scales = "free", nrow=1, ncol=4) +
#   geom_point(size=2, alpha=0.2) +
#   xlab("") + ylab("CPUE (n trap-1)") +
#   geom_errorbar(data = profit_stats, aes(ymin=catch_per_trap-se, ymax=catch_per_trap+se), size=.5, width=0)
# 
# #ggsave(file="output/Profit.png", profit_fig, width = 7, height = 4, units = c("in"))
```

## Nutrient info 

```{r}
nutrient_raw <- read.csv("data/SpeciesData_GatedTraps_Galligan_edited.csv", sep = ",", header=TRUE) %>%
  dplyr::rename(scientific_name = Species)

nut_biomassdf <- left_join(biomass_df, nutrient_raw, by = "scientific_name")

### to calculate nutrient components per group of fish per survey 
## W_g = calculated biomass (g)
## Nutrient_mgPer100g 
## (W_g/100)*Nutrient_mgPer100g = nutrientmg for that group of fish in that survey 
## use biomasscomp (kg) x 1000 = biomasscomp_g for the below 
nut_biomassdf <- nut_biomassdf %>%
  mutate(biomasscomp_g = biomasscomp*1000) %>%
  # calculating nutrient for each scientific name within a survey 
  mutate(spp_Calcium = (biomasscomp_g/100)*Calcium_mgPer100g,
         spp_Iron = (biomasscomp_g/100)*Iron_mgPer100g,
         spp_Omega3 = (biomasscomp_g/100)*Omega3_gPer100g,
         spp_Protein = (biomasscomp_g/100)*Protein_gPer100g,
         spp_VitaminA = (biomasscomp_g/100)*VitaminA_ugPer100g,
         spp_Selenium = (biomasscomp_g/100)*Selenium_ugPer100g,
         spp_Zinc = (biomasscomp_g/100)*Zinc_mgPer100g) %>% 
  # calculating total nutrient for each survey 
  group_by(survey_id) %>%
  mutate(pertrap_Calcium = sum(spp_Calcium)/total_traps_collected,
         pertrap_Iron = sum(spp_Iron)/total_traps_collected,
         pertrap_Omega3 = sum(spp_Omega3)/total_traps_collected,
         pertrap_Protein = sum(spp_Protein)/total_traps_collected,
         pertrap_VitaminA = sum(spp_VitaminA)/total_traps_collected,
         pertrap_Selenium = sum(spp_Selenium)/total_traps_collected,
         pertrap_Zinc = sum(spp_Zinc)/total_traps_collected) %>% ungroup()

nut_biomassdf %>%
  dplyr::select(survey_id, trap_type, pertrap_Calcium, pertrap_Iron, pertrap_Omega3, spp_Protein, spp_VitaminA, 
                spp_Selenium, spp_Zinc) %>%
  gather(., "measurement", "value", 3:9) %>% distinct() %>%
  filter(!is.na(trap_type)) %>%
  ggplot(., aes(x=trap_type, y=value, color = trap_type)) + 
  geom_boxplot() + geom_jitter(size=0.5, alpha=0.1, width=0.2) + theme_classic() +
  facet_wrap(~measurement, scales = "free_y") + 
  scale_color_manual(values = c( "#387780", "#FF8C61")) +
  theme(strip.text.x = element_text(size = 12, color = "black", face = "bold"),
  strip.text.y = element_text(size = 12, color = "black", face = "bold")) +
  theme(strip.background = element_rect(color="black", fill="white", linewidth=0.5, linetype="solid")) +
  ylab("nutritional content (mg survey-1)")

#ggsave(file="output/Nutrient.png", nutrient_plot, width = 10, height = 8, units = c("in"))
```

Individual plots 

```{r}
nut_biomassdf_individual<- nut_biomassdf %>% 
  select(survey_id, pertrap_Zinc, trap_type) %>% distinct() %>%
  ggbetweenstats(., x = trap_type, y = pertrap_Zinc, 
               type = "np", plot.type = "boxviolin", sample.size.label = TRUE,
               mean.point.args = list(size = 2, color = "gray"),
               mean.label.args = list(size = 2),
               point.args = list(position = ggplot2::position_jitterdodge(dodge.width = 0.5), 
                                 alpha= 0.1, size = 1, stroke = 0)) +
  scale_color_manual(values = c( "black", "black")) +
  labs(x = "Trap Type", y = "Zinc (per trap)")

ggsave(file="output/Nutrient_Zinc_calculated.png", nut_biomassdf_individual, width = 4.5, height = 5, units = c("in"))

nutrient_stats <- nut_biomassdf %>% 
  select(survey_id, pertrap_Zinc, trap_type) %>% 
  distinct() %>% filter(!is.na(pertrap_Zinc))

nutrient_stats2 <- summarySE(nutrient_stats, measurevar = c("pertrap_Zinc"), 
                             groupvars = c("trap_type"))

t.test(pertrap_Zinc~trap_type, data = nutrient_stats, var.equal = FALSE)
nutrient_stats2
```

Bycatch data 

```{r}
bycatch_raw <- read.csv("data/SpeciesData_GatedTraps_Galligan_edited.csv", sep = ",", header=TRUE) %>%
  dplyr::rename(scientific_name = Species) %>% subset(Bycatch == "Yes")
  
bycatchdf <- nut_biomassdf %>% subset(Bycatch == "Yes") %>% 
  select(survey_id, scientific_name, total_traps_collected, trap_type, biomasscomp) %>%
  group_by(survey_id) %>%
  mutate(bycatch_kg = sum(biomasscomp),
         bycatch_kg_pertrap = bycatch_kg/total_traps_collected) %>% ungroup()

bycatchdf2 <- bycatchdf %>% dplyr::select(survey_id, bycatch_kg_pertrap, trap_type) %>% distinct() 

bycatchdf2%>%
  ggplot(., aes(x=trap_type, y=bycatch_kg_pertrap)) + geom_boxplot() + geom_point()

unique(bycatchdf$scientific_name)

t.test(bycatch_kg_pertrap~trap_type, data = bycatchdf2, var.equal = FALSE)

bycatchdf2_stats <- bycatchdf2 %>% 
  filter(!is.na(bycatch_kg_pertrap)) %>% filter_at(vars(bycatch_kg_pertrap), all_vars(!is.infinite(.)))

bycatchdf2_stats <- summarySE(bycatchdf2_stats, measurevar = c("bycatch_kg_pertrap"), 
                             groupvars = c("trap_type"))
```


### Creating dataframe for collaborators

Metadata (collabdf1)

Per household category metrics:

- Number of fish per home/fish dealer/etc per survey 
- Calculated value (KSHperspp) 
- Calculated biomass (W_kg) 
- Calculated calcium (spp_Calcium)
- Calculated iron (spp_Iron)
- Calculated Omega3 (spp_Omega3)
- Calculated Protein (spp_Protein)
- Calculated Vitamin A (spp_VitaminA)
- Calculated Selenium (spp_Selenium)
- Calculated Zinc (spp_Zinc)

Per trap metrics (collabdf2 & collabdf3) [not household level]: 

- reported biomass (reported_kg_trap)
- reported value (reported_KES_trap)
- catch per unit effort (CPUE) 
- Calculated value (KSHpersurvey & KSHpertrap) [collabdf3]
- Calculated biomass kg (calculated_biomass_pertrap)
- Calculated calcium (pertrap_Calcium)
- Calculated iron (pertrap_Iron)
- Calculated Omega3 (pertrap_Omega3)
- Calculated Protein (pertrap_Protein)
- Calculated Vitamin A (pertrap_VitaminA)
- Calculated Selenium (pertrap_Selenium)
- Calculated Zinc (pertrap_Zinc)

```{r}
collabdf1 <- data %>% dplyr::select(survey_id, Operation_date, year, month, day, enumerator, landing_site, 
                                    BMU, fisher_id, household_id) %>% distinct()

collabdf2 <- modified_trap_df %>% 
  dplyr::select(survey_id, trap_type, total_traps_collected, 
                kg_per_trap, catch_per_trap, value_per_trap) %>%
  dplyr::rename(reported_kg_trap = kg_per_trap) %>% 
  dplyr::rename(CPUE = catch_per_trap) %>%
  dplyr::rename(reported_KES_trap = value_per_trap) %>% distinct()

collabdf3 <- nut_biomassdf %>% dplyr::select(-Operation_date, -year, -month, -day, -enumerator, -trap_type,
                                             -total_traps_collected, -total_biomass_kg, -total_value_KES,
                                             -length_cm, -number_of_fish, -crew_size_corrected,
                                             -median_length, -FishGroups, -EnglishName) %>% distinct()

collabdf4 <- gilligan_profit_data %>% 
  dplyr::select(survey_id, scientific_name, KSHperspp, KSHpersurvey, KSHpertrap) %>% distinct()

collabdf <- left_join(collabdf1, collabdf2, by = "survey_id") %>% 
  full_join(., collabdf3, by = "survey_id") %>%
  full_join(., collabdf4, by = c("survey_id", "scientific_name")) %>% distinct()


precollab5 <- gilligan_profit_data %>% 
  dplyr::select(survey_id, scientific_name, length_corrected, KSHperspp) %>% distinct()
precollab5_2 <- nut_biomassdf %>% 
  dplyr::select(survey_id, scientific_name, length_corrected, biomasscomp, W_kg, spp_Zinc, spp_Selenium, spp_VitaminA, 
                spp_Protein, spp_Omega3, spp_Iron, spp_Calcium) %>% distinct()

collabdf5 <- data %>% 
  dplyr::select(survey_id, Operation_date, year, month, day, enumerator, landing_site, 
                BMU, fisher_id, household_id, scientific_name, 
                destination, trap_type, number_of_fish, length_corrected) %>%
  distinct() %>% 
  mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>%
  dplyr::full_join(., precollab5, by = c("survey_id","scientific_name", "length_corrected")) %>%
  dplyr::full_join(., precollab5_2, by = c("survey_id","scientific_name", "length_corrected")) %>% 
  distinct() %>% filter(!is.na(trap_type)) 

# collabdf1 %>% write.csv("output/survey_metainfo.csv")
# collabdf2 %>% write.csv("output/survey_reported_pertrap_metrics.csv")
# collabdf3 %>% write.csv("output/survey_biomass_nutrient.csv")
# collabdf4 %>% write.csv("output/survey_revenue.csv")

collabdf6 <- collabdf5 %>% dplyr::group_by(survey_id, destination) %>%
  filter(!is.na(KSHperspp)) %>%
  dplyr::mutate(fish_perdestination = sum(number_of_fish),
                biomass_perdestination = sum(biomasscomp),
         KSH_perdestination = sum(KSHperspp),
         calculated_Kg_perdestination = sum(W_kg),
         Zinc_perdestination = sum(spp_Zinc),
         Selenium_perdestination = sum(spp_Selenium),
         VitaminA_perdestination = sum(spp_VitaminA),
         Protein_perdestination = sum(spp_Protein),
         Omega3_perdestination = sum(spp_Omega3),
         Iron_perdestination = sum(spp_Iron),
         Calcium_perdestination = sum(spp_Calcium)) %>%
  dplyr::select(-length_corrected, -number_of_fish, -scientific_name,
                -KSHperspp, -W_kg, -spp_Zinc, -spp_Selenium, -spp_VitaminA,
                -spp_Protein, -spp_Omega3, -spp_Iron, -spp_Calcium, -biomasscomp) %>% ungroup() %>%
  distinct()

home_df <- collabdf6 %>% subset(destination == "HOME")
fishdealer_df <- collabdf6 %>% subset(destination == "FISH DEALER")
mamakaranga_df <- collabdf6 %>% subset(destination == "MAMA KARANGA")

home_df %>% write.csv("output/desintation_home.csv")
fishdealer_df %>% write.csv("output/desintation_fishdealer.csv")
mamakaranga_df %>% write.csv("output/desintation_mamakaranga.csv")

```

Editing dataframe for collaborators 

```{r}
# collabdf1 <- read.csv("output/survey_metainfo.csv") %>% dplyr::select(-X)
# collabdf2 <- read.csv("output/survey_reported_pertrap_metrics.csv") %>% dplyr::select(-X)
# collabdf3 <- read.csv("output/survey_biomass_nutrient.csv") %>% dplyr::select(-X) #%>%
#   # dplyr::select(survey_id, calculated_total_biomass, calculated_biomass_pertrap, 
#   #               pertrap_Calcium, pertrap_Iron, pertrap_Omega3, pertrap_Protein, 
#   #               pertrap_VitaminA, pertrap_Selenium, pertrap_Zinc) %>%
#   # dplyr::rename(calculated_biomass_persurvey = calculated_total_biomass) %>% distinct()
# collabdf4 <- read.csv("output/survey_revenue.csv") %>% dplyr::select(-X) #%>%
#   #dplyr::select(survey_id, KSHpersurvey, KSHpertrap) %>% distinct()
# 
# collabdf1 %>% write.csv("output/survey_metainfo.csv")
# collabdf2 %>% write.csv("output/survey_reported_pertrap_metrics.csv")
# collabdf3 %>% write.csv("output/survey_biomass_nutrient.csv")
# collabdf4 %>% write.csv("output/survey_revenue.csv")
```

Calculate % take home 

```{r}
percent_takehome <- collabdf6 %>% ungroup() %>%
  dplyr::select(survey_id, trap_type, destination, biomass_perdestination) %>% distinct() %>%
  group_by(survey_id) %>%
  tidyr::spread(destination, biomass_perdestination) %>%
  replace(., is.na(.), 0) %>%
  mutate(sum = rowSums(across(c(`FISH DEALER`, GIFT, HOME, `MAMA KARANGA`, OTHER))),
         percent_home = (HOME/sum)*100) %>%
  filter(HOME < 50)

hist(percent_takehome$HOME)

### % HOME
percent_takehome_plot <-  percent_takehome %>% 
  filter(percent_home > 0.00) %>%
  ggbetweenstats(., x = trap_type, y = percent_home, 
               type = "np", plot.type = "boxviolin", sample.size.label = TRUE,
               mean.point.args = list(size = 2, color = "gray"),
               mean.label.args = list(size = 2),
               point.args = list(position = ggplot2::position_jitterdodge(dodge.width = 0.5), 
                                 alpha= 0.1, size = 1, stroke = 0)) +
  scale_color_manual(values = c( "black", "black")) +
  labs(x = "Trap Type", y = "% take home")

#ggsave(file="output/Takehome.png", percent_takehome_plot, width = 4.5, height = 5, units = c("in"))

takehome_stats <- percent_takehome %>% 
  filter(percent_home > 0.00)

takehome_stats2 <- summarySE(takehome_stats, measurevar = c("percent_home"), 
                             groupvars = c("trap_type"))

t.test(percent_home~trap_type, data = takehome_stats, var.equal = FALSE)
takehome_stats2

### BIOMASS HOME
takehome_plot <-  percent_takehome %>% ungroup() %>%
  filter(HOME > 0.00) %>%
  ggbetweenstats(., x = trap_type, y = HOME, 
               type = "np", plot.type = "boxviolin", sample.size.label = TRUE,
               mean.point.args = list(size = 2, color = "gray"),
               mean.label.args = list(size = 2),
               point.args = list(position = ggplot2::position_jitterdodge(dodge.width = 0.05), 
                                 alpha= 0.15, size = 1, stroke = 0)) +
  scale_color_manual(values = c( "black", "black")) +
  labs(x = "Trap Type", y = "Biomass kg take home")

ggsave(file="output/Biomass_takenhome.png", takehome_plot, width = 4.5, height = 5, units = c("in"))

takehome_no_stats <- percent_takehome %>% 
  filter(HOME > 0.00)

percent_takehome %>% ungroup() %>% count(HOME)
### 1,666/3,974 not taken home 

takehome_no_stats2 <- summarySE(takehome_no_stats, measurevar = c("HOME"), 
                             groupvars = c("trap_type"))

t.test(HOME~trap_type, data = takehome_no_stats, var.equal = FALSE)
takehome_no_stats2

```



