---
title: "CPUE, maturity, and length analysis of Fishing Landings dataset"
author: "Author: Emma Strand; emma_strand@uri.edu"
output:
  github_document: default
  pdf_document:
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Calculations Made (all only unmodified and modified traps)

In `modified_trap_df`:  
Grouped by survey id (operation date + fisher ID):  
- `total_catch` (total number of fish in that fishing trip) = sum of `number_of_fish`   
- `kg_per_trap` (total # kg per trap -- Biomass) = total_biomass_kg/total_traps_collected   
- `catch_per_trap` (# of fish per trap -- Abundance) = total_catch/total_traps_collected   


In `species_list` to calculate top 10 species throughout entire survey:  
Grouped by species and trap type,
- `species_catch` = sum of `number_of_fish`  


In `species_df` to calculate top species regardless of trap type:  
Grouped by species,   
- `species_total_catch` = sum of `number_of_fish`


In `species_df` to calculate abundance for each top species:  
Dataset filtered to only top 10 species:  
Grouped by survey id and species,  
- `topspecies_catch` = sum of `number_of_fish` (number of fish in top 10 for each trap, not the same # of fish value as above calculations)    
- `catch_per_trap` = topspecies_catch/total_traps_collected. *Catch per trap is the # of that species / trap # from that survey* i.e. 25 Siganus sutor individuals / 4 traps collected for that fishing trip = there are 6.25 Siganus sutor per trap set. 


In `maturity` to calculate the abundance of mature and immature fish:  
- `median_length` is the median of the length bin (i.e. 6-10 bin = median length of 8, 71-80 bin = median length of 75.5)  
Grouped by survey id, species, maturity, trap type:  
- `nofish_pertrap` = number of fish / total traps collected.  
  

## Contents 

- [**Reading in datafiles**](#data)  
- [**Total catch (grams) per unit effort (trap set)**](#catch_effort)  
- [**Calculate top species caught**](#species)  
- [**Top species stats per trap**](#species_pertrap)  
- [**Creating database from Fishbase**](#fishbase)  
- [**Catch per unit effort for top species by maturity**](#maturity)  
- [**Catch and length data of mature fish**](#length)   
- [**Length Frequency plots of top species**](#freq_plots)   

## <a name="data"></a> **Reading in datafiles**

```{r, message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(readxl)
library(lubridate)
library(Hmisc)
library(writexl)
library(naniar)
library(Rmisc)
library(stats)
library(lme4)
library(car)
```

## Read in the data frame that is the output of the QC script. 

```{r, message=FALSE, warning=FALSE}
# read in excel file
data <- read_excel("data/cleaned-Fishlandings-data- CC-JM-Clay-IW updated 04-09-2022.xlsx") #read in excel file 

data <- data %>% separate(Operation_date, c("year", "month", "day"), remove = FALSE) # creating new columns with month year and date
data$month <- as.numeric(data$month) #changing this column to numeric instead of a character (needed for next fxn)
data$month <- month.abb[data$month] #changing numeric months to month names 

data$month <- factor(data$month, levels=c("Jan", "Feb","Mar","Apr","May","Jun",
                                          "Jul", "Aug", "Sep", "Oct", "Dec", "NA"))

data$total_traps_collected[data$total_traps_collected == 0] <- NA
```

## Creating a survey id and calculating total catch, catch per trap, kg per trap

```{r}
data <- data %>%
  unite(survey_id, Operation_date, fisher_id, date_time_collected, sep = " ", remove = FALSE) %>% # needs to be both bc data input has errors
  subset(trap_type == "MODIFIED" | trap_type == "UNMODIFIED") %>%
  mutate(trap_type = case_when(
    trap_type == "MODIFIED" ~ "Experimental",
    trap_type == "UNMODIFIED" ~ "Control")) %>% # renaming modified and unmodified to experimental and control
  dplyr::group_by(survey_id) %>% # group by survey id
  mutate(total_catch = sum(number_of_fish), #count the number of fish caught for each survey id
         kg_per_trap = total_biomass_kg/total_traps_collected, #divide total weight for survey id by total traps 
         catch_per_trap = total_catch/total_traps_collected,
         value_per_trap = total_value_KES/total_traps_collected) %>% #divide total catch per survey id by total traps 
  dplyr::ungroup(survey_id) # ungroup
```

## Calculating top species 

```{r}
species_list <- data %>% select(scientific_name, number_of_fish, trap_type) %>% 
  filter(!is.na(trap_type)) %>% 
  filter(!is.na(number_of_fish)) %>% 
  dplyr::group_by(scientific_name, trap_type) %>%
  mutate(species_catch = sum(number_of_fish)) %>% 
  select(-number_of_fish) %>% distinct() %>%
  ungroup()

# print top 5 species from modified traps 
species_list %>% subset(trap_type == "Experimental") %>%                                    
  arrange(desc(species_catch)) %>% head(5)

# print top 5 species from unmodified traps 
species_list %>% subset(trap_type == "Control") %>%                                    
  arrange(desc(species_catch)) %>% head(5)
```

## Calculating median length per trap

```{r}
data <- data %>%
  mutate(median_length = case_when(
    length_corrected == "0-10" ~ 5,
    length_corrected == "11-15" ~ 13,
    length_corrected == "16-20" ~ 18,
    length_corrected == "21-25" ~ 23,
    length_corrected == "26-30" ~ 28,
    length_corrected == "31-35" ~ 33,
    length_corrected == "36-40" ~ 38,
    length_corrected == "41-45" ~ 43,
    length_corrected == "46-50" ~ 48,
    length_corrected == "51-60" ~ 55.5,
    length_corrected == "61-70" ~ 65.5,
    length_corrected == "71-80" ~ 75.5,
    length_corrected == "81-90" ~ 85.5,
    length_corrected == ">90" ~ 100 ### circle back to what value to use here
  )) 

length_df <- data %>% 
  select(survey_id, total_traps_collected, scientific_name, number_of_fish, trap_type,
         length_corrected, median_length) %>%
  mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
  tidyr::uncount(., number_of_fish, .remove = TRUE) %>% # expanding number of fish to number of observations
  dplyr::group_by(survey_id) %>% # group by survey id
  mutate(mean_length_persurvey = mean(median_length)) %>%
  ungroup() %>% select(-scientific_name, -length_corrected, -median_length, -total_traps_collected) %>%
  distinct()

Legnth_persurvey <- length_df %>% 
  ggplot(aes(x=trap_type, y=mean_length_persurvey)) +
  geom_boxplot(outlier.size = 0, lwd=0.5) +
  #color_scale_manual(values = c(""))
  geom_point(size=0.75) +
  theme_classic() + 
  ylab("Length (cm)") + #xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle
ggsave(file="output/Length_persurvey.png", Legnth_persurvey, width = 4, height = 4, units = c("in"))


UN_length <- length_df %>% subset(trap_type == "Control") %>% filter(!is.na(mean_length_persurvey)) 
MOD_length <- length_df %>% subset(trap_type == "Experimental") %>% filter(!is.na(mean_length_persurvey))

var.test(UN_length$mean_length_persurvey, MOD_length$mean_length_persurvey)
t.test(mean_length_persurvey~trap_type, data = length_df, var.equal = FALSE)
```

## <a name="catch_effort"></a> **Total catch (grams) per unit effort (trap set)**

**Total catch per unit effort between modified and traditional traps. It would be great to see this as grams captured per trap set.**

Grouping by fisher_id but this might be effective to group by enumerator once I have correct list of names. There are 3 boat trips recorded with the exact same fish data that are under 3 different fisher ID names but all the same enumerator.. come back to this in QC.

Goal: kilograms captured per trap set.

```{r}
modified_trap_df <- data %>%
  select(survey_id, enumerator, trap_type, total_traps_collected, 
         `No. of fishers in crew`, landing_site, total_catch, month, 
         year, kg_per_trap, catch_per_trap, value_per_trap) %>%
  distinct()
```

### Plotting figures.

Abundance = Catch per trap 

```{r}
# basic total catch per trap with no other variables 
CPUE_n <- modified_trap_df %>% 
  ggplot(aes(x=trap_type, y=catch_per_trap)) +
  geom_boxplot(outlier.size = 0, lwd=0.5) +
  #color_scale_manual(values = c(""))
    geom_point(size=0.75) +
  theme_classic() + 
  ylab("Abundance (# of individuals per trap collected)") + #xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle
ggsave(file="output/CPUE.png", CPUE_n, width = 4, height = 4, units = c("in"))


# by fisherman 
modified_trap_df %>% 
  ggplot(aes(x=trap_type, y=catch_per_trap, color=trap_type)) + 
  facet_wrap(~enumerator) +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Abundance (# of individuals per trap collected)") + #xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle

# by landing site
modified_trap_df %>% 
  ggplot(aes(x=trap_type, y=catch_per_trap, color=trap_type)) + 
  facet_wrap(~landing_site) +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Abundance (# of individuals per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle

# by month and year 
modified_trap_df %>% unite(ym, year, month, sep = " ", remove = FALSE) %>% filter(catch_per_trap < 1500) %>%
  ggplot(aes(x=month, y=catch_per_trap, color=trap_type)) + 
  facet_wrap(~year, scales = "free_y") +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
  #geom_point(aes(x=ym, y=catch_per_trap, fill=trap_type), pch = 21, size=1) +
  theme_classic() + 
  ylab("Abundance (# of individuals per trap collected)") + xlab("Time of year") +
  theme(axis.text.x = element_text(vjust = 1.1, hjust=1.1, angle=60)) #Set the text angle
```

Biomass = Kilograms per trap 

```{r}
# basic grams per trap plot with no other variables 
Yield_reported <- modified_trap_df %>% 
  ggplot(aes(x=trap_type, y=kg_per_trap)) + 
  geom_boxplot(outlier.size = 0, lwd=0.5) +
    geom_point(size=0.75) +
  theme_classic() + 
  ylab("Biomass (kg per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle
ggsave(file="output/Yield_reported.png", Yield_reported, width = 4, height = 4, units = c("in"))


# visually seeing if this differs by fisherman 
modified_trap_df %>% 
  ggplot(aes(x=trap_type, y=kg_per_trap, color=trap_type)) + 
  facet_wrap(~enumerator) +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Biomass (kg per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle

# visually seeing if this differs by landing site 
modified_trap_df %>% 
  ggplot(aes(x=trap_type, y=kg_per_trap, color=trap_type)) + 
  facet_wrap(~landing_site) +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Biomass (kg per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle

# by month and year 
modified_trap_df %>% unite(ym, year, month, sep = " ", remove = FALSE) %>% #filter(catch_per_trap < 1500) %>%
  ggplot(aes(x=month, y=kg_per_trap, color=trap_type)) + 
  facet_wrap(~year) +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
 # geom_point(aes(x=month, group=trap_type, y=grams_per_trap, fill=trap_type), pch = 21, size=1) +
  theme_classic() + 
  ylab("Biomass (kg per trap collected)") + xlab("Time of year") +
  theme(axis.text.x = element_text(vjust = 1.1, hjust=1.1, angle=60)) #Set the text angle
```

Value reported per trap

```{r}
Value_reported <- modified_trap_df %>% 
  ggplot(aes(x=trap_type, y=value_per_trap)) + 
  geom_boxplot(outlier.size = 0, lwd=0.5) +
    geom_point(size=0.75) +
  theme_classic() + 
  ylab("Value (KES per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle
ggsave(file="output/Value_reported.png", Value_reported, width = 4, height = 4, units = c("in"))
```


The relationship between grams per trap and total catch per trap. 

```{r}
modified_trap_df %>% filter(catch_per_trap < 1500) %>%
  ggplot(aes(x=catch_per_trap, y=kg_per_trap, color=trap_type)) +
  theme_bw() + xlab("Abundance (# of individuals per trap collected)") + ylab("Biomass (kg per trap collected)") +
  geom_smooth(aes(fill=trap_type), method="loess", se=TRUE, fullrange=TRUE, level=0.95, color="black") +
  geom_point(aes(fill=trap_type), pch = 21, size=1)
```

### Statistics on the above. 

Default of t.test in R is a Welch t-test which is just an adaptation of t-test, and it is used when the two samples have possibly unequal variances. Use var.equal = TRUE or FALSE to specifiy the variances of the dataset. 

You can test equal variances with a Fisher's F-test. If p < 0.05 then we include var.equal = FALSE in below ttest. If p > 0.05 then we include var.equal = TRUE in below ttest.

We are using an unpaired two sample t-test for this dataset. 

```{r}
UN <- modified_trap_df %>% subset(trap_type == "Control") %>% filter(!is.na(kg_per_trap)) %>% 
  filter(!is.na(catch_per_trap)) %>% filter(!is.na(value_per_trap))
MOD <- modified_trap_df %>% subset(trap_type == "Experimental") %>% filter(!is.na(kg_per_trap)) %>% 
  filter(!is.na(catch_per_trap)) %>% filter(!is.na(value_per_trap))
```

#### Kilograms per trap 

```{r}
var.test(UN$kg_per_trap, MOD$kg_per_trap)
t.test(kg_per_trap~trap_type, data = modified_trap_df, var.equal = FALSE)
```

#### Total catch per trap  

```{r}
var.test(UN$catch_per_trap, MOD$catch_per_trap)
t.test(catch_per_trap~trap_type, data = modified_trap_df, var.equal = FALSE)
```

#### Total catch per trap  

```{r}
var.test(UN$value_per_trap, MOD$value_per_trap)
t.test(value_per_trap~trap_type, data = modified_trap_df, var.equal = TRUE)
```

#### Total catch per trap vs weight in grams per trap. 

We use a linear mixed model for this so we can include other variables like fisherman and landing site. 

Grams per trap is log transformed.

I'm not sure yet if this is the best way to do this... 

```{r}
# unmodified
un_catch_model <- lmer(log(kg_per_trap) ~ catch_per_trap + (1|enumerator) + (1|landing_site), na.action=na.omit, data=UN)
qqPlot(residuals(un_catch_model)) 
hist(residuals(un_catch_model))

# modified
mod_catch_model <- lmer(log(kg_per_trap) ~ catch_per_trap + (1|enumerator) + (1|landing_site), na.action=na.omit, data=MOD)
qqPlot(residuals(mod_catch_model)) 
hist(residuals(mod_catch_model))

summary(un_catch_model)
summary(mod_catch_model)

Anova(un_catch_model, ddf="lme4", type='III')
Anova(mod_catch_model, ddf="lme4", type='III')
```

## <a name="species"></a> **Calculate top species caught**

**Species catch per unit effort between modified and traditional traps. Take the top 3-5 species and run #1 for them separately.**

Calculating which species were the most abundant across the entire survey.  

This might have to be number of fish caught per trap? So that the difference in # of traps for modified and unmodified is accounted for?

This is split for modified and unmodified so far.. but can be changed to combined.. the trend is about the same for most abundant type of fish in each trap.. 

```{r}
# above 250 cut off includes top each count for each type of trap 
species_list %>% filter(species_catch > 250) %>%
  ggplot(., aes(x=scientific_name, y=species_catch, group = trap_type, color = trap_type)) + 
  ylab("number of fish caught") + xlab("Genus species") +
  ggtitle("Species with counts > 250") +
  geom_point() + theme_bw() + theme(axis.text.x = element_text(angle = 60, hjust=1)) #Set the text angle
```

## <a name="species_pertrap"></a> **Top species stats per trap**

Create a subsetted df from the top 10 total species (break this down into modified and unmodified later?).

```{r}
# calculate species total catch to then figure out which ones were most popular regardless of trap type
species_df <- data %>% filter(!is.na(number_of_fish)) %>%
  group_by(scientific_name) %>%
  mutate(species_total_catch = sum(number_of_fish)) %>% ungroup() #must ungroup for following commands 

# use the above metric to subset to top 10 of those 
species_keep <- species_df %>% select(scientific_name, species_total_catch) %>% 
  distinct() %>% slice_max(species_total_catch, n = 10) 

# filter species df based on the species_keep list 
species_df <- species_df %>% filter(scientific_name %in% species_keep$scientific_name)

# double checking the above command worked - output should be only 5 
unique(sort(species_df$scientific_name))
```

### Abundance  

```{r}
### species_df is already subsetted to the top 10 species 
# within each survey id, for each species calculate topspecies_catch as the number fish in that species in that survey
# then calculate the catch per trap as the number of fish of that species over the total number of traps collected
species_df <- species_df %>%
  dplyr::group_by(survey_id, scientific_name) %>% # group by survey id
  mutate(topspecies_catch = sum(number_of_fish),
         catch_per_trap = topspecies_catch/total_traps_collected) %>% #divide total catch per survey id by total traps 
  dplyr::ungroup(survey_id, scientific_name) #ungroup by this column

species_df %>%
  ggplot(aes(x=trap_type, y=catch_per_trap, color=trap_type)) + 
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
  facet_wrap(~scientific_name, scales = "free_y") +
  theme_classic() + ggtitle("Top 10 most abundant species") +
  ylab("Abundance (# of individuals per trap collected)") + xlab("Genus species") +
  theme(axis.text.x = element_text()) #Set the text angle
```


### Statistics for the top ten species

Left off at trying to solve the following error when running aov: 

Error in as.POSIXlt.character(x, tz, ...) : character string is not in a standard unambiguous format

Error in lm.fit(x, y, offset = offset, singular.ok = singular.ok, ...) : NA/NaN/Inf in 'y'

```{r}
Topspp_MOD <- species_df %>% subset(trap_type == "Experimental")

Topspp_UNMOD <- species_df %>% subset(trap_type == "Control")  

var.test(Topspp_MOD$catch_per_trap, MOD$catch_per_trap) # output is significant so put false below

#t.test(catch_per_trap~trap_type, data = species_df, var.equal = FALSE)

#aov(catch_per_trap ~ trap_type + scientific_name, data = species_df)
```


## <a name="maturity"></a> **Catch per unit effort for top species by maturity**

**Total mature fish catch per unit effort between modified and traditional traps. This will have to be for the top 3-5 species separately. Go to Fishbase and find the length at first maturity for that particular species, then assign each fish a "mature" or "immature" status in the data and calculate.**

Data pulled from Fishbase and put in the datasheet `fishbase.xlsx`. 

```{r}
fishbase <- read_excel("data/fishbase.xlsx", sheet = "life history") %>% #read in excel file 
  select(scientific_name, Lm, Lm_se_min, Lm_se_max, Lmax)

maturity <- full_join(data, fishbase, by = "scientific_name") %>% # joining maturity reproduction info with main dataframe
  filter(!is.na(Lm)) # taking out observations that don't have an Lm value so only the top species 

maturity <- maturity %>% 
  mutate(maturity = if_else(median_length >= Lm, "mature", "immature")) %>%
  subset(trap_type == "Experimental" | trap_type == "Control") %>% #subsetting to only the modified and unmodified traps 
  select(survey_id, year, scientific_name, trap_type, maturity, total_traps_collected, 
         length_corrected, median_length, number_of_fish, Lm) %>%
  mutate(nofish_pertrap = number_of_fish/total_traps_collected) 
```

Immaure and mature fish catch comparison

```{r}
maturity %>% select(number_of_fish, trap_type, maturity, scientific_name, 
                    total_traps_collected, nofish_pertrap) %>% 
  na.omit() %>% 
  ggplot(., aes(x=scientific_name, y=nofish_pertrap, color=maturity)) +
  geom_boxplot() + theme_classic() + 
  theme(axis.text.x = element_text(angle=60, hjust=1)) +
  xlab("Species") +
  ylab("Abundance (number of individuals per trap collected)")

maturity %>% select(number_of_fish, trap_type, maturity, scientific_name, total_traps_collected, nofish_pertrap) %>% 
  na.omit() %>%  
  ggplot(., aes(x=maturity, y=nofish_pertrap, color=trap_type)) +
  geom_boxplot() + theme_classic() + 
  facet_wrap(~trap_type, scales = "free_y") +
  #theme(axis.text.x = element_text(angle=60, hjust=1)) +
  xlab("Maturity") +
  ylab("Abundance (number of individuals per trap collected)")
```

Statistics on the above... 

Circle back to the padj values coming out to "0.000000e+00". 

Double check `trap_type+maturity` vs `trap_type*maturity`.  

```{r}
nofish_maturity_aov <- aov(number_of_fish ~ trap_type*maturity, data = maturity)
summary(nofish_maturity_aov)

nofish_maturity_tukey <- TukeyHSD(nofish_maturity_aov)
nofish_maturity_tukey$`trap_type:maturity`
```

## <a name="length"></a> **Catch and length data of mature fish**

**Average length of catch versus length at first maturity (Lmat). Take the difference for each fish in the data against its length at first maturity and then calculate a weighted value for modified versus traditional traps where a value above 0 represents a fish above Lmat and a value below represents a fish below Lmat.**

Transform count value to that number of observations: https://stackoverflow.com/questions/70759069/transform-count-column-into-number-of-rows. 

```{r}
maturity_dist <- maturity %>% 
  mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
  tidyr::uncount(., number_of_fish, .remove = TRUE) %>% # expanding number of fish to number of observations
  mutate(length_dist = median_length-Lm) %>%
  filter(!is.na(length_dist)) %>%
  group_by(scientific_name, trap_type) %>%
  mutate(avg_length_dist = mean(length_dist)) %>% #### a positive value here = mature; a negative value = immature 
  ungroup() 

maturity_dist %>%
  #subset(scientific_name == "Siganus sutor" | scientific_name == "Lethrinus nebulosus" |
  #         scientific_name == "Scarus ghobban" | scientific_name == "Leptoscarus vaigiensis" |
  #         scientific_name == "Siganus canaliculatus") %>%
  group_by(scientific_name) %>%
  filter(., n_distinct(avg_length_dist) >= 2) %>% # filters out the observations aren't in both categories (takes out species that only have 1 unique mean dist value so only 1 trap type)
  ungroup() %>%
  ggplot(., aes(x=scientific_name, y=avg_length_dist, color = trap_type)) + coord_flip() +
  geom_hline(yintercept = 0, lty = "dotted") +
  geom_line(aes(group = scientific_name), color="grey14") +
  geom_point() + theme_bw() + 
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0))) +
 # theme(axis.text.x = element_text(angle=60, hjust=1)) +
  labs(y="Mean distance from Lm (cm)", x="Genus species", color="Trap Type")
```



## <a name="freq_plots"></a> **Length Frequency plots of top species**

**Length frequency of top 3-5 species in modified versus traditional (different colors) with Lmat etc. indicators pulled from Fishbase.**


Check this calculation for each fish not just each survey id???

http://derekogle.com/fishR/2017-07-28-JoyPlot

From the `species_keep` df:

Siganus sutor	= 311813  	 		 
Lethrinus nebulosus	= 51612	     		
Scarus ghobban	= 34253  			  
Siganus canaliculatus	= 23173  		  	
Leptoscarus vaigiensis	= 15758	  

```{r}
library(ggridges)

# the column we want to plot: maturity$length_corrected
maturity$length_corrected <- factor(maturity$length_corrected, levels=c("0-10", "11-15","16-20","21-25","26-30",
                                                                        "31-35","36-40","41-45", "46-50", "51-60",
                                                                        "61-70", "71-80", "81-90", ">90"))

maturity <- maturity %>% filter(!is.na(length_corrected)) %>%
  group_by(length_corrected, scientific_name, trap_type) %>%
  mutate(count.per.bin = sum(number_of_fish)) %>%
  ungroup()

maturity2022_topspp <- maturity %>% subset(year=="2022") %>% 
  subset(scientific_name == "Siganus sutor" | scientific_name == "Lethrinus nebulosus" |
           scientific_name == "Scarus ghobban" | scientific_name == "Leptoscarus vaigiensis" |
           scientific_name == "Siganus canaliculatus") %>%
    mutate(Lm_range = case_when(
    Lm >= 0 & Lm <= 10.5 ~ "0-10",
    Lm >= 10.5 & Lm <= 15.4 ~ "11-15",
    Lm >= 15.5 & Lm <= 20.4 ~ "16-20",
    Lm >= 20.5 & Lm <= 25.4 ~ "21-25",
    Lm >= 25.5 & Lm <= 30.4 ~ "26-30",
    Lm >= 30.5 & Lm <= 35.4 ~ "31-35",
    Lm >= 35.5 & Lm <= 40.4 ~ "36-40",
    Lm >= 40.5 & Lm <= 45.4 ~ "41-45",
    Lm >= 45.5 & Lm <= 50.4 ~ "46-50",
    Lm >= 50.5 & Lm <= 60.4 ~ "51-60",
    Lm >= 60.5 & Lm <= 70.4 ~ "61-70",
    Lm >= 70.5 & Lm <= 80.4 ~ "71-80",
    Lm >= 80.5 & Lm <= 90.4 ~ "81-90",
    Lm > 90.5 ~ ">90")) 

# creating table that will work best for visualization 
maturity_figs <- maturity2022_topspp %>% 
  mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
  tidyr::uncount(., number_of_fish, .remove = TRUE)

# setting common figure parameters 
a <- maturity_figs %>% # expanding number of fish to number of observations
  ggplot(., aes(x=length_corrected, fill=trap_type, color=trap_type)) + 
  theme_bw() + xlab("Length (cm)") + ylab("Frequency") +
  theme(axis.text.x.bottom = element_text(colour = 'black', angle = 60, hjust = 1),
        axis.text.y = element_text(colour = 'black', size = 8, face = 'italic')) + 
  theme(panel.border = element_blank(),
   panel.grid.major = element_blank(),
   panel.grid.minor = element_blank(),
   strip.text.x = element_text(size = 9, color = "black", face = "bold.italic"),
   axis.line = element_line(colour = "black")) +
  theme(axis.title.y = element_text(size = 12, face = "bold", margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  theme(axis.title.x = element_text(size = 12, face = "bold", margin = margin(t = 10, r = 0, b = 0, l = 0))) +
  facet_wrap(~scientific_name, scales = "free_y") +
  ggtitle("Not standardized by per trap - come back to this?")
```


### Calculating % fish underneath Lm and sample size per trap type for the figure below 

```{r}
maturity_calcs <- maturity_figs %>%
  group_by(scientific_name, trap_type) %>%
  mutate(sample_size = n(),
         count_below = sum(median_length <= Lm, na.rm=TRUE),
         percent_below = (count_below/sample_size)*100) %>%
 select(scientific_name, trap_type, sample_size, 
         count_below, percent_below) %>% 
  ungroup() %>% distinct()

# double checking the above calculation worked
maturity_figs %>% filter(scientific_name == "Siganus sutor", trap_type == "UNMODIFIED") %>%
  count(maturity == "immature") 
```


```{r}
a +
  geom_bar(position = position_dodge(), alpha=0.5)

### left off at trying to get a density or geom smooth on categorical data - haven't been able to make that work
a + geom_histogram(aes(y = ..count.., colour = trap_type, fill = trap_type), 
                   alpha = 0.6, position = position_dodge(), stat="count") +
  geom_vline(data = maturity_figs, mapping = aes(xintercept = Lm_range), lty = "dotted", size=1.2)
```

https://rstudio-pubs-static.s3.amazonaws.com/595950_6dc36259819541e5869f9fff162a8a41.html#histogram

https://statisticsglobe.com/normal-density-curve-on-top-of-histogram-ggplot2-r

## Fishbase R 

https://github.com/ropensci/rfishbase

Left off at FishBase R having SSL certificate problems. Download a and b from fishbase for top 5 and make script for this. 

```{r}
#remotes::install_github("ropensci/rfishbase")
library("rfishbase")
#library(curl)
#install.packages("curl", type = "source")
```

```{r}
#FB <- fb_tbl("ecology")
```

Error: 

  `Error in curl::curl_fetch_memory(file, handle): SSL certificate problem: certificate has expired
  Error in curl::curl_fetch_memory(file, handle): SSL certificate problem: certificate has expired
  Error in curl::curl_fetch_memory(file, handle): SSL certificate problem: certificate has expired
  Error in curl::curl_fetch_memory(file, handle): SSL certificate problem: certificate has expired
  Warning in curl::curl_fetch_memory(url, handle = handle) :
    SSL certificate problem: certificate has expired
  Warning in curl::curl_fetch_memory(url, handle = handle) :
    SSL certificate problem: certificate has expired
  Error in rbind(deparse.level, ...) : 
    numbers of columns of arguments do not match`
    

### Biomass per trap collected

1.) Expand df by # of fish so that each row is a fish observation.    
2.) Calculate median length of the bin of each fish (L).   
3.) Find a and b parameters for all fish. Add this to the fishbase and read in that df.  
4.) Add a and b columns to `species_df` by species Id.  
5.) Mutate to calculate W=aLb.  
6.) Group by species and survey id to calculate biomass per trap collected.   

#### Calculating biomass

W=aL^b 

W = Biomass  
L = Length (in our case, median length)  
a = (taken from fishbase)
b = (taken from fishbase)

Read in data from fishbase. These units are in cm and grams. 

https://www.fishbase.de/manual/English/FishbaseThe_LENGTH_WEIGHT_table.htm


```{r}
biomass_fishbase <- read_excel("data/fishbase.xlsx", sheet = "biomass") %>% #read in excel file 
  select(scientific_name, a, b)

biomass_survey_data <- data %>% filter(!is.na(number_of_fish)) %>%
  subset(trap_type == "MODIFIED" | trap_type == "UNMODIFIED") %>%
  select(survey_id, Operation_date, year, month, day, enumerator, trap_type, total_traps_collected,
         total_biomass_kg, take_home_weight_kg, total_value_KES, take_home_value_KES, scientific_name, 
         length_cm, number_of_fish, crew_size_corrected, length_corrected) 

biomass_df <- full_join(biomass_survey_data, biomass_fishbase, by = "scientific_name") 

biomass_df <- biomass_df %>%
 # mutate(number_of_fish = if_else(is.na(number_of_fish), 1, number_of_fish)) %>% # replacing NAs with the value of 1
 # tidyr::uncount(., number_of_fish, .remove = TRUE) %>%
  mutate(median_length = case_when(
    length_corrected == "0-10" ~ 5,
    length_corrected == "11-15" ~ 13,
    length_corrected == "16-20" ~ 18,
    length_corrected == "21-25" ~ 23,
    length_corrected == "26-30" ~ 28,
    length_corrected == "31-35" ~ 33,
    length_corrected == "36-40" ~ 38,
    length_corrected == "41-45" ~ 43,
    length_corrected == "46-50" ~ 48,
    length_corrected == "51-60" ~ 55.5,
    length_corrected == "61-70" ~ 65.5,
    length_corrected == "71-80" ~ 75.5,
    length_corrected == "81-90" ~ 85.5,
    length_corrected == ">90" ~ 100 ### circle back to what value to use here
  )) %>%
  mutate(W_g = (a*(median_length^b))*number_of_fish,
         W_kg = W_g/1000) %>% # calculating biomass from W=aL^b 
  group_by(survey_id) %>%
  mutate(calculated_total_biomass = sum(W_kg),
         calculated_biomass_pertrap = calculated_total_biomass/total_traps_collected) %>% 
  ungroup()

biomass_comparison <- biomass_df %>% select(survey_id, total_biomass_kg, calculated_total_biomass) %>%
  distinct() %>% na.omit() %>%
  mutate(comparison = if_else(total_biomass_kg > calculated_total_biomass, "REPORTED > CALC", "REPORTED < CALC"),
         difference = total_biomass_kg-calculated_total_biomass) 

biomass_comparison %>%
  ggplot(., aes(x=comparison, y=difference)) + theme_bw() +
  geom_point(aes(color=comparison), size=1) + xlab("") + ylab("difference in value")
```

Calculated biomass per trap figures. 

```{r}
# basic grams per trap plot with no other variables 
biomass_df %>% filter(!is.na(calculated_biomass_pertrap)) %>%
  ggplot(aes(x=trap_type, y=calculated_biomass_pertrap, color=trap_type)) + 
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Calculated Biomass (kg per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle

# visually seeing if this differs by fisherman 
biomass_df %>% filter(!is.na(calculated_biomass_pertrap)) %>%
  ggplot(aes(x=trap_type, y=calculated_biomass_pertrap, color=trap_type)) + 
  facet_wrap(~enumerator) +
  geom_boxplot(aes(color=trap_type), outlier.size = 0, lwd=0.5) +
    geom_point(aes(fill=trap_type), pch = 21, size=1) +
  theme_bw() + 
  ylab("Calculated Biomass (kg per trap collected)") + xlab("Type of trap") +
  theme(axis.text.x = element_text(vjust = 1.1)) #Set the text angle
```


List of species to ask Fishbase for a and b. 

```{r}
biomass_df %>% 
  select(scientific_name) %>% distinct() %>%
  write.csv("data/full_species_list.csv")
```







